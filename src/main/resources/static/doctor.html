<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ì‚¬ ì§„ë£Œ ì‹œìŠ¤í…œ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- WebSocket ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        /* ì•”í˜¸ ì…ë ¥ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .password-modal {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .password-modal h2 {
            margin-bottom: 1rem;
            color: #333;
        }

        .password-input {
            width: 100%;
            padding: 0.8rem;
            margin: 1rem 0;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            text-align: center;
        }

        .password-input:focus {
            outline: none;
            border-color: #333;
        }

        .password-btn {
            width: 100%;
            padding: 0.8rem;
            background: white;
            color: #333;
            border: 2px solid #333;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .password-btn:hover {
            background: #f8f9fa;
            border-color: #000;
            color: #000;
        }

        .password-error {
            color: #dc3545;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .main-content-wrapper {
            display: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            color: black;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: left;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .sidebar {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }

        .patient-area {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: white;
            color: #333;
            border: 2px solid #333;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            background: #f8f9fa;
            border-color: #000;
            color: #000;
        }

        .btn-success {
            background: white;
            color: #333;
            border: 2px solid #333;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            background: #f8f9fa;
            border-color: #000;
            color: #000;
        }

        .btn-warning {
            background: white;
            color: #333;
            border: 2px solid #333;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            background: #f8f9fa;
            border-color: #000;
            color: #000;
        }

        .btn-danger {
            background: white;
            color: #333;
            border: 2px solid #333;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            background: #f8f9fa;
            border-color: #000;
            color: #000;
        }

        .waiting-queue {
            margin-bottom: 30px;
        }

        .queue-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .queue-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .queue-item.current {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-color: #333;
            cursor: pointer;
        }

        .patient-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #333;
        }

        .patient-info h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .info-label {
            font-weight: 600;
            color: #4a5568;
        }

        .info-value {
            color: #2d3748;
        }

        .prescription-form {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #333;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .prescription-preview {
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 30px;
            margin-top: 20px;
            font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .prescription-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 3px solid #333;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .clinic-info {
            text-align: left;
        }

        .clinic-info h2 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .clinic-info p {
            color: #666;
            font-size: 0.9em;
            margin: 2px 0;
        }

        .prescription-title {
            text-align: center;
        }

        .prescription-title h1 {
            color: #333;
            font-size: 2.2em;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .prescription-title p {
            color: #666;
            font-size: 1em;
        }

        .patient-info-section {
            margin-bottom: 30px;
        }

        .patient-info-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #333;
        }

        .patient-info-table td {
            padding: 12px 15px;
            border: 1px solid #333;
            font-size: 1em;
        }

        .patient-info-table td:first-child,
        .patient-info-table td:nth-child(3) {
            background: #f8f9fa;
            width: 120px;
            font-weight: 600;
        }

        .prescription-section {
            margin-bottom: 25px;
        }

        .prescription-section h3 {
            color: #333;
            font-size: 1.3em;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #333;
        }

        .prescription-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #333;
        }

        .prescription-table th,
        .prescription-table td {
            padding: 12px 15px;
            border: 1px solid #333;
            text-align: left;
        }

        .prescription-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .prescription-table tbody tr:nth-child(even) {
            background: #f9f9f9;
        }

        .notes-box,
        .followup-box {
            border: 2px solid #333;
            padding: 15px;
            background: #f8f9fa;
            min-height: 60px;
            border-radius: 4px;
        }

        .prescription-footer {
            margin-top: 40px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .doctor-info {
            text-align: left;
        }

        .doctor-info p {
            margin: 5px 0;
            font-size: 1em;
        }

        .prescription-note {
            text-align: right;
            font-size: 0.9em;
            color: #666;
        }

        .prescription-note p {
            margin: 3px 0;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid;
        }

        .alert-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .hidden {
            display: none;
        }

        /* EMR ìŠ¤íƒ€ì¼ */
        .emr-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: visible;
            position: relative;
        }

        .section-header {
            background: white;
            color: #333;
            border: 2px solid #333;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h4 {
            margin: 0;
            font-size: 1.1em;
        }

        .emr-section .form-group,
        .emr-section .form-row,
        .emr-section .patient-basic-info,
        .emr-section .soap-section {
            padding: 15px 20px;
        }

        .patient-basic-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            background: white;
        }

        .info-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-label {
            font-weight: 600;
            color: #4a5568;
            min-width: 80px;
        }

        .info-value {
            color: #2d3748;
            font-weight: 500;
        }

        /* SOAP ìŠ¤íƒ€ì¼ */
        .soap-section {
            background: white;
            border-bottom: 1px solid #e9ecef;
            margin: 0;
        }

        .soap-section:last-child {
            border-bottom: none;
        }

        .soap-label {
            display: inline-block;
            width: 25px;
            height: 25px;
            background: white;
            color: #333;
            border: 2px solid #333;
            border-radius: 50%;
            text-align: center;
            line-height: 21px;
            font-weight: bold;
            margin-right: 10px;
        }

        .soap-section label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
            display: block;
        }

        .soap-section textarea {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 10px;
            font-size: 14px;
            resize: vertical;
        }

        /* ì§„ë‹¨ëª… ê²€ìƒ‰ ë“œë¡­ë‹¤ìš´ */
        .diagnosis-dropdown, .medication-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 9999;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .diagnosis-item, .medication-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f7fafc;
            transition: background-color 0.2s;
        }

        .diagnosis-item:hover, .medication-item:hover {
            background: #f7fafc;
        }

        .diagnosis-item:last-child, .medication-item:last-child {
            border-bottom: none;
        }

        .medication-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .medication-info {
            flex: 1;
        }

        .medication-name {
            font-weight: 600;
            color: #2d3748;
        }

        .medication-details {
            font-size: 0.85em;
            color: #666;
            margin-top: 2px;
        }

        .medication-category {
            font-size: 0.75em;
            color: #999;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }

        /* ì§„ë‹¨ ì •ë³´ ì„¹ì…˜ íŠ¹ë³„ ìŠ¤íƒ€ì¼ */
        .diagnosis-section {
            position: relative;
            z-index: 100;
        }

        .diagnosis-section .emr-section {
            overflow: visible;
        }

        .diagnosis-name {
            font-weight: 600;
            color: #2d3748;
        }

        .diagnosis-code {
            font-size: 0.9em;
            color: #666;
            margin-left: 10px;
        }

        /* ì•½ë¬¼ ì²˜ë°© í…Œì´ë¸” */
        .medication-table-container {
            background: white;
            padding: 20px;
            overflow-x: auto;
        }

        .medication-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e2e8f0;
        }

        .medication-table th,
        .medication-table td {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            text-align: left;
        }

        .medication-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }

        .medication-table input,
        .medication-table select {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 5px 8px;
            font-size: 14px;
        }

        .medication-table .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* ì§„ë‹¨ëª… í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .diagnosis-table-container {
            background: white;
            padding: 20px;
            overflow-x: auto;
            margin-top: 15px;
        }

        .diagnosis-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e2e8f0;
        }

        .diagnosis-table th,
        .diagnosis-table td {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            text-align: left;
        }

        .diagnosis-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }

        .diagnosis-table .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°œì„  */
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.875rem;
        }

        .btn-danger {
            background: white;
            color: #333;
            border: 2px solid #333;
        }

        .btn-danger:hover {
            background: #f8f9fa;
            border-color: #000;
            color: #000;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            background: #e2e8f0;
            color: #4a5568;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ì•”í˜¸ ì…ë ¥ í™”ë©´ -->
    <div id="passwordOverlay" class="password-overlay">
        <div class="password-modal">
            <h2><i class="fas fa-lock"></i> ì˜ì‚¬ í˜ì´ì§€ ì ‘ê·¼</h2>
            <p>ì•”í˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
            <input type="password" id="passwordInput" class="password-input" placeholder="ì•”í˜¸ ì…ë ¥" maxlength="20">
            <button onclick="checkPassword()" class="password-btn">í™•ì¸</button>
            <div id="passwordError" class="password-error"></div>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="main-content-wrapper">
            <div class="header">
                <h1><i class="fas fa-hospital"></i> ì„œëŒ€ ë³‘ì›</h1>
            </div>

        <div class="main-content">
            <!-- ì‚¬ì´ë“œë°” -->
            <div class="sidebar">
                <div class="section-title">ì§„ë£Œ ëŒ€ê¸°ì—´</div>
                <div class="waiting-queue">
                    <button class="btn btn-primary" onclick="loadWaitingQueue()" style="width: 100%; margin-bottom: 15px;">
                        ëŒ€ê¸°ì—´ ìƒˆë¡œê³ ì¹¨
                    </button>
                    <div id="waitingQueue" class="loading">
                        ëŒ€ê¸°ì—´ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                </div>

                <div class="section-title">ì§„ë£Œ ì¤‘ì¸ í™˜ì</div>
                <div id="currentPatients" class="loading">
                    ì§„ë£Œ ì¤‘ì¸ í™˜ìë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>

                <button class="btn btn-success" onclick="callNextPatient()" style="width: 100%; margin-top: 20px;">
                    ë‹¤ìŒ í™˜ì í˜¸ì¶œ
                </button>
            </div>

            <!-- í™˜ì ì§„ë£Œ ì˜ì—­ -->
            <div class="patient-area">
                <div class="section-title">í™˜ì ì§„ë£Œ</div>
                
                <!-- ì•Œë¦¼ ë©”ì‹œì§€ -->
                <div id="alertMessage" class="hidden"></div>

                <!-- í™˜ì ì •ë³´ -->
                <div id="patientInfo" class="hidden">
                    <div class="patient-info">
                        <h3>í™˜ì ì •ë³´</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">í™˜ìëª…:</span>
                                <span class="info-value" id="patientName">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ìƒë…„ì›”ì¼:</span>
                                <span class="info-value" id="patientBirthDate">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ì „í™”ë²ˆí˜¸:</span>
                                <span class="info-value" id="patientPhone">-</span>
                            </div>
                        </div>
                        
                        <!-- ë¬¸ì§„í‘œ ì •ë³´ -->
                        <div id="surveyInfo" class="hidden">
                            <h4 style="margin-top: 15px; margin-bottom: 10px; color: #333;">ë¬¸ì§„í‘œ ì •ë³´</h4>
                            <div class="info-item">
                                <span class="info-label">ë‚´ì› ì‚¬ìœ :</span>
                                <span class="info-value" id="visitReason">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ì¦ìƒ:</span>
                                <span class="info-value" id="symptoms">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ì•Œë ˆë¥´ê¸°:</span>
                                <span class="info-value" id="allergies">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ë³µìš© ì•½ë¬¼:</span>
                                <span class="info-value" id="medications">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ê³¼ê±° ë³‘ë ¥:</span>
                                <span class="info-value" id="medicalHistory">-</span>
                            </div>
                        </div>
                        
                        <!-- ë°”ì´íƒˆì‚¬ì¸ ì •ë³´ -->
                        <div id="vitalSignInfo" class="hidden">
                            <h4 style="margin-top: 15px; margin-bottom: 10px; color: #333;"><i class="fas fa-stethoscope"></i> ë°”ì´íƒˆì‚¬ì¸ ì •ë³´</h4>
                            <div class="info-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                                <div class="info-item">
                                    <span class="info-label">ì²´ì˜¨:</span>
                                    <span class="info-value" id="vitalBodyTemp">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">í˜ˆì••:</span>
                                    <span class="info-value" id="vitalBloodPressure">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">ë§¥ë°•:</span>
                                    <span class="info-value" id="vitalPulse">-</span>
                                </div>
                            </div>
                            <div class="info-item" style="margin-top: 10px;">
                                <span class="info-label">ì²´í¬ ì¦ìƒ:</span>
                                <span class="info-value" id="vitalSymptoms">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ê¸°íƒ€ ì¦ìƒ:</span>
                                <span class="info-value" id="vitalOtherSymptoms">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ê³¼ê±°ë ¥:</span>
                                <span class="info-value" id="vitalMedicalHistory">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ê°„í˜¸ì‚¬ ë©”ëª¨:</span>
                                <span class="info-value" id="vitalNurseNotes">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ì¸¡ì • ê°„í˜¸ì‚¬:</span>
                                <span class="info-value" id="vitalNurseId">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- EMR ì²˜ë°©ì „ ì‘ì„± í¼ -->
                <div id="prescriptionForm" class="prescription-form hidden">
                    <h3 style="margin-bottom: 20px; color: #333;"><i class="fas fa-prescription-bottle-alt"></i> EMR ì²˜ë°©ì „ ì‘ì„±</h3>
                    
                    <form id="prescriptionFormData">
                        <input type="hidden" id="currentReceptionId" name="receptionId">
                        
                        <!-- ê¸°ë³¸ ì •ë³´ ë¸”ë¡ -->
                        <div class="emr-section">
                            <div class="section-header">
                                <h4>ğŸ‘¤ ê¸°ë³¸ ì •ë³´</h4>
                            </div>
                            <div class="patient-basic-info">
                                <div class="info-row">
                                    <span class="info-label">í™˜ìëª…:</span>
                                    <span class="info-value" id="emrPatientName">-</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">ìƒë…„ì›”ì¼:</span>
                                    <span class="info-value" id="emrPatientBirth">-</span>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">ë°©ë¬¸ì¼ì:</span>
                                    <span class="info-value" id="emrVisitDate">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- ì§„ë‹¨ ì •ë³´ (ìƒë³‘ ë“±ë¡) -->
                        <div class="emr-section diagnosis-section">
                            <div class="section-header">
                                <h4><i class="fas fa-search"></i> ì§„ë‹¨ ì •ë³´ (ìƒë³‘ ë“±ë¡)</h4>
                                <button type="button" class="btn btn-sm btn-primary" onclick="addDiagnosisRow()">ì§„ë‹¨ëª… ì¶”ê°€</button>
                            </div>
                            <div class="form-row">
                                <div class="form-group" style="position: relative; z-index: 1000;">
                                    <label for="diagnosisSearch">ì§„ë‹¨ëª… ê²€ìƒ‰ *</label>
                                    <input type="text" id="diagnosisSearch" placeholder="ì§„ë‹¨ëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ê°ê¸°, ìœ„ì—¼, ê³ í˜ˆì••)" autocomplete="off">
                                    <div id="diagnosisDropdown" class="diagnosis-dropdown"></div>
                                </div>
                                <div class="form-group">
                                    <label for="diagnosisCode">ìƒë³‘ì½”ë“œ</label>
                                    <input type="text" id="diagnosisCode" name="diagnosisCode" readonly placeholder="ì§„ë‹¨ëª… ì„ íƒ ì‹œ ìë™ ì…ë ¥">
                                </div>
                            </div>
                            
                            <!-- ì§„ë‹¨ëª… í…Œì´ë¸” -->
                            <div class="diagnosis-table-container">
                                <table class="diagnosis-table">
                                    <thead>
                                        <tr>
                                            <th>ì§„ë‹¨ëª…</th>
                                            <th>ìƒë³‘ì½”ë“œ</th>
                                            <th>ì‚­ì œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="diagnosisTableBody">
                                        <!-- ì§„ë‹¨ëª… í–‰ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <input type="hidden" id="finalDiagnosis" name="diagnosis">
                        </div>

                        <!-- SOAP í˜•ì‹ ì§„ë£Œ ê¸°ë¡ -->
                        <div class="emr-section">
                            <div class="section-header">
                                <h4><i class="fas fa-edit"></i> SOAP ì§„ë£Œ ê¸°ë¡</h4>
                            </div>
                            
                            <!-- S: Subjective (ì£¼ê´€ì  ì†Œê²¬) -->
                            <div class="soap-section">
                                <label for="subjective">
                                    <span class="soap-label">S</span> ì£¼ê´€ì  ì†Œê²¬ (í™˜ì í˜¸ì†Œ ì¦ìƒ)
                                </label>
                                <textarea id="subjective" name="subjective" rows="4" 
                                    placeholder="í™˜ìê°€ í˜¸ì†Œí•˜ëŠ” ì¦ìƒì„ ê¸°ë¡í•˜ì„¸ìš” (ì˜ˆ: 3ì¼ ì „ë¶€í„° ëª©ì´ ì•„í”„ê³  ë¯¸ì—´ì´ ìˆìŒ)"></textarea>
                            </div>

                            <!-- O: Objective (ê°ê´€ì  ì†Œê²¬) -->
                            <div class="soap-section">
                                <label for="objective">
                                    <span class="soap-label">O</span> ê°ê´€ì  ì†Œê²¬ (ì§„ì°° ê²°ê³¼)
                                </label>
                                <textarea id="objective" name="objective" rows="2" 
                                    placeholder="ì˜ì‚¬ì˜ ì§„ì°° ê²°ê³¼ë¥¼ ê¸°ë¡í•˜ì„¸ìš” (ì˜ˆ: ì¸ë‘ ë°œì  ìˆìŒ, ì²´ì˜¨ 37.9â„ƒ)"></textarea>
                            </div>

                            <!-- A: Assessment (í‰ê°€ ë° ì§„ë‹¨) -->
                            <div class="soap-section">
                                <label for="assessment">
                                    <span class="soap-label">A</span> í‰ê°€ ë° ì§„ë‹¨
                                </label>
                                <textarea id="assessment" name="assessment" rows="2" 
                                    placeholder="ìµœì¢… íŒë‹¨ ë‚´ìš©ì„ ê¸°ë¡í•˜ì„¸ìš” (ì˜ˆ: ìƒê¸°ë„ ê°ì—¼ìœ¼ë¡œ íŒë‹¨ë¨)"></textarea>
                            </div>

                            <!-- P: Plan (ì¹˜ë£Œ ê³„íš) -->
                            <div class="soap-section">
                                <label for="plan">
                                    <span class="soap-label">P</span> ì¹˜ë£Œ ê³„íš
                                </label>
                                <textarea id="plan" name="plan" rows="2" 
                                    placeholder="ì¹˜ë£Œ ê³„íšì„ ê¸°ë¡í•˜ì„¸ìš” (ì˜ˆ: ì•½ë¬¼ ì¹˜ë£Œ, ìƒí™œ ì§€ë„, ì¬ì§„ ì•ˆë‚´ ë“±)"></textarea>
                            </div>
                        </div>

                        <!-- ì•½ë¬¼ ì²˜ë°© í…Œì´ë¸” -->
                        <div class="emr-section">
                            <div class="section-header">
                                <h4>ğŸ’Š ì•½ë¬¼ ì²˜ë°©</h4>
                                <button type="button" class="btn btn-sm btn-primary" onclick="addMedicationRow()">ì•½ë¬¼ ì¶”ê°€</button>
                            </div>
                            
                            <!-- ì•½ë¬¼ ê²€ìƒ‰ -->
                            <div class="form-row">
                                <div class="form-group" style="position: relative; z-index: 999;">
                                    <label for="medicationSearch">ì•½ë¬¼ ê²€ìƒ‰</label>
                                    <input type="text" id="medicationSearch" placeholder="ì•½ë¬¼ëª…ì´ë‚˜ ì¦ìƒì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë°œì—´, ë‘í†µ)" autocomplete="off">
                                    <div id="medicationDropdown" class="medication-dropdown"></div>
                                </div>
                            </div>
                            
                            <div class="medication-table-container">
                                <table class="medication-table">
                                    <thead>
                                        <tr>
                                            <th>ì•½ë¬¼ëª…</th>
                                            <th>ìš©ëŸ‰</th>
                                            <th>ë³µìš©íšŸìˆ˜</th>
                                            <th>ì²˜ë°©ì¼ìˆ˜</th>
                                            <th>ë³µìš©ë²•</th>
                                            <th>ê¸‰ì—¬êµ¬ë¶„</th>
                                            <th>ì‚­ì œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="medicationTableBody">
                                        <!-- ì•½ë¬¼ í–‰ë“¤ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- ë³µì•½ì§€ë„ -->
                        <div class="emr-section">
                            <div class="section-header">
                                <h4>ğŸ“‹ ë³µì•½ì§€ë„</h4>
                            </div>
                            <div class="form-group">
                                <label for="medicationGuidance">ë³µìš© ë°©ë²• ë° ì£¼ì˜ì‚¬í•­</label>
                                <textarea id="medicationGuidance" name="medicationGuidance" rows="3" 
                                    placeholder="ë³µìš© ë°©ë²•, ì£¼ì˜ì‚¬í•­ ë“±ì„ ìƒì„¸íˆ ê¸°ì¬í•´ì£¼ì„¸ìš” (ì˜ˆ: ì¡¸ë¦´ ìˆ˜ ìˆì–´ ìš´ì „ ê¸ˆì§€, ì‹í›„ ë³µìš©)"></textarea>
                            </div>
                        </div>

                        <!-- ì˜ì‚¬ íŠ¹ì´ì‚¬í•­ ë° ì¬ì§„ -->
                        <div class="emr-section">
                            <div class="section-header">
                                <h4>ğŸ©º ì˜ì‚¬ ì†Œê²¬ ë° ì¬ì§„</h4>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="doctorNotes">ì˜ì‚¬ íŠ¹ì´ì‚¬í•­</label>
                                    <textarea id="doctorNotes" name="doctorNotes" rows="2" 
                                        placeholder="í™˜ì ìƒíƒœ, ë¹„ê³  ë“±ì„ ê¸°ì¬í•´ì£¼ì„¸ìš”"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="followUpDate">ì¬ì§„ ë‚ ì§œ</label>
                                    <select id="followUpDate" name="followUpDate">
                                        <option value="">ì¬ì§„ ë¶ˆí•„ìš”</option>
                                        <option value="3days">3ì¼ í›„</option>
                                        <option value="1week">1ì£¼ì¼ í›„</option>
                                        <option value="2weeks">2ì£¼ì¼ í›„</option>
                                        <option value="1month">1ê°œì›” í›„</option>
                                        <option value="2months">2ê°œì›” í›„</option>
                                        <option value="3months">3ê°œì›” í›„</option>
                                        <option value="custom">ì§ì ‘ ì…ë ¥</option>
                                    </select>
                                    <input type="datetime-local" id="customFollowUpDate" name="customFollowUpDate" class="hidden" style="margin-top: 10px;">
                                </div>
                            </div>
                        </div>

                        <!-- ì €ì¥ ë° ì¶œë ¥ ë²„íŠ¼ -->
                        <div style="text-align: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <button type="button" class="btn btn-primary" onclick="savePrescription()">
                                ì²˜ë°©ì „ ì €ì¥
                            </button>
                            <button type="button" class="btn btn-warning" onclick="previewPrescription()">
                                ì²˜ë°©ì „ ë¯¸ë¦¬ë³´ê¸°
                            </button>
                            <button type="button" class="btn btn-success" onclick="handleCompleteReception()" id="completeBtn" disabled>
                                ì§„ë£Œ ì™„ë£Œ
                            </button>
                        </div>
                    </form>
                </div>

                <!-- ì²˜ë°©ì „ ë¯¸ë¦¬ë³´ê¸° -->
                <div id="prescriptionPreview" class="prescription-preview hidden">
                    <div class="prescription-header">
                        <div class="clinic-info">
                            <h2>ì„œëŒ€ ë³‘ì›</h2>
                            <p>ì¶©ë¶ ì²­ì£¼ì‹œ ì„œì›êµ¬ ë¬´ì‹¬ì„œë¡œ 377-3 ì„œì›ëŒ€í•™êµ (ìš°: 28674)</p>
                            <p>ì „í™”: 02-1234-5678 | íŒ©ìŠ¤: 02-1234-5679</p>
                        </div>
                        <div class="prescription-title">
                            <h1>ì²˜ ë°© ì „</h1>
                            <p>ë°œí–‰ì¼: <span id="prescriptionDate"></span></p>
                        </div>
                    </div>
                    
                    <div class="prescription-content">
                        <div class="patient-info-section">
                            <table class="patient-info-table">
                                <tr>
                                    <td><strong>í™˜ìì„±ëª…:</strong></td>
                                    <td><span id="previewPatientName"></span></td>
                                    <td><strong>ìƒë…„ì›”ì¼:</strong></td>
                                    <td><span id="previewPatientBirth"></span></td>
                                </tr>
                                <tr>
                                    <td><strong>ì§„ë‹¨ëª…:</strong></td>
                                    <td colspan="3"><span id="previewDiagnosis"></span></td>
                                </tr>
                            </table>
                        </div>
                        
                        <div class="prescription-section">
                            <h3>ì²˜ë°©ë‚´ì—­</h3>
                            <table class="prescription-table">
                                <thead>
                                    <tr>
                                        <th>ì•½í’ˆëª…</th>
                                        <th>ìš©ë²•Â·ìš©ëŸ‰</th>
                                        <th>íˆ¬ì•½ì¼ìˆ˜</th>
                                        <th>ë¹„ê³ </th>
                                    </tr>
                                </thead>
                                <tbody id="previewMedicationTableBody">
                                    <!-- ì²˜ë°© ì•½ë¬¼ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="prescription-section">
                            <h3>ì˜ì‚¬ ì†Œê²¬</h3>
                            <div class="notes-box">
                                <span id="previewNotes"></span>
                            </div>
                        </div>
                        
                        <div class="prescription-section">
                            <h3>ì¬ì§„ ì˜ˆì •ì¼</h3>
                            <div class="followup-box">
                                <span id="previewFollowUp"></span>
                            </div>
                        </div>
                        
                        <div class="prescription-footer">
                            <div class="doctor-info">
                                <p><strong>ì²˜ë°©ì˜ì‚¬:</strong> ê°•ì°¬í¬ (ë©´í—ˆë²ˆí˜¸: 12345)</p>
                                <p><strong>ì˜ë£Œê¸°ê´€:</strong> ì„œëŒ€ ë³‘ì›</p>
                            </div>
                            <div class="prescription-note">
                                <p>â€» ì˜ì•½í’ˆ ë³µìš© ì‹œ ì£¼ì˜ì‚¬í•­ì„ ë°˜ë“œì‹œ í™•ì¸í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ë¹ˆ ìƒíƒœ -->
                <div id="emptyState" class="empty-state">
                    <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.5;"><i class="fas fa-user-md"></i></div>
                    <h3>í™˜ìë¥¼ í˜¸ì¶œí•´ì£¼ì„¸ìš”</h3>
                    <p>ì¢Œì¸¡ ëŒ€ê¸°ì—´ì—ì„œ í™˜ìë¥¼ í˜¸ì¶œí•˜ì—¬ ì§„ë£Œë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPatient = null;
        let currentReception = null;
        let prescriptionSaved = false;

        // ìƒë³‘ì½”ë“œ ë°ì´í„° (ì‹¤ì œ ì˜ì›ì—ì„œ ìì£¼ ì‚¬ìš©ë˜ëŠ” ê¸°ì¤€)
        const diagnosisData = [
            // ê°ê¸° / í˜¸í¡ê¸°
            { diagnosis: "ê¸‰ì„± ë¹„ì¸ë‘ì—¼", searchTerms: ["ê°ê¸°", "ë¹„ì¸ë‘ì—¼", "ì½§ë¬¼", "ì½”ë§‰í˜"], code: "J00" },
            { diagnosis: "ê¸‰ì„± ì¸ë‘ì—¼", searchTerms: ["ì¸ë‘ì—¼", "ëª©ê°ê¸°", "ëª©ì•„í””"], code: "J02.9" },
            { diagnosis: "ê¸‰ì„± í¸ë„ì—¼", searchTerms: ["í¸ë„ì—¼", "í¸ë„ì„ ", "ëª©êµ¬ë©"], code: "J03.9" },
            { diagnosis: "ê¸‰ì„± ê¸°ê´€ì§€ì—¼", searchTerms: ["ê¸°ê´€ì§€ì—¼", "ê¸°ì¹¨", "ê°€ë˜"], code: "J20.9" },
            { diagnosis: "ì¸í”Œë£¨ì—”ì", searchTerms: ["ë…ê°", "ì¸í”Œë£¨ì—”ì", "ëª¸ì‚´"], code: "J11.1" },
            { diagnosis: "ì•Œë ˆë¥´ê¸° ë¹„ì—¼", searchTerms: ["ì•Œë ˆë¥´ê¸°", "ë¹„ì—¼", "ì¬ì±„ê¸°"], code: "J30.1" },
            { diagnosis: "ë¶€ë¹„ë™ì—¼", searchTerms: ["ì¶•ë†ì¦", "ë¶€ë¹„ë™ì—¼", "ì½”ë§‰í˜"], code: "J01.9" },
            { diagnosis: "í›„ë‘ì—¼", searchTerms: ["í›„ë‘ì—¼", "ì‰°ëª©ì†Œë¦¬", "ëª©ì†Œë¦¬"], code: "J04.0" },
            { diagnosis: "ì²œì‹", searchTerms: ["ì²œì‹", "ìˆ¨ê°€ì¨", "í˜¸í¡ê³¤ë€"], code: "J45.9" },
            
            // ì†Œí™”ê¸°ê³„
            { diagnosis: "ê¸‰ì„± ìœ„ì¥ì—¼", searchTerms: ["ìœ„ì¥ì—¼", "ì„¤ì‚¬", "ë³µí†µ", "ì¥ì—¼"], code: "K52.9" },
            { diagnosis: "ê¸°ëŠ¥ì„± ì†Œí™”ë¶ˆëŸ‰", searchTerms: ["ì†Œí™”ë¶ˆëŸ‰", "ì²´í•¨", "ì†ì“°ë¦¼"], code: "K30" },
            { diagnosis: "ìœ„ì—¼", searchTerms: ["ìœ„ì—¼", "ì†ì“°ë¦¼", "ìœ„í†µ"], code: "K29.7" },
            { diagnosis: "ìœ„Â·ì‹­ì´ì§€ì¥ ê¶¤ì–‘", searchTerms: ["ê¶¤ì–‘", "ìœ„ê¶¤ì–‘", "ì‹­ì´ì§€ì¥"], code: "K27.9" },
            { diagnosis: "ì—­ë¥˜ì„± ì‹ë„ì—¼", searchTerms: ["ì—­ë¥˜ì„±", "ì‹ë„ì—¼", "ì†ì“°ë¦¼"], code: "K21.0" },
            { diagnosis: "ê³¼ë¯¼ì„± ëŒ€ì¥ ì¦í›„êµ°", searchTerms: ["ê³¼ë¯¼ì„±", "ëŒ€ì¥", "ë³€ë¹„", "ì„¤ì‚¬"], code: "K58.9" },
            
            // ë‚´ë¶„ë¹„Â·ëŒ€ì‚¬
            { diagnosis: "ì œ2í˜• ë‹¹ë‡¨ë³‘", searchTerms: ["ë‹¹ë‡¨ë³‘", "ë‹¹ë‡¨", "í˜ˆë‹¹"], code: "E11.9" },
            { diagnosis: "ê³ ì§€í˜ˆì¦", searchTerms: ["ê³ ì§€í˜ˆì¦", "ì½œë ˆìŠ¤í…Œë¡¤", "ì¤‘ì„±ì§€ë°©"], code: "E78.5" },
            { diagnosis: "ê°‘ìƒì„  ê¸°ëŠ¥ì €í•˜ì¦", searchTerms: ["ê°‘ìƒì„ ", "ê¸°ëŠ¥ì €í•˜", "ê°‘ì €"], code: "E03.9" },
            { diagnosis: "ê°‘ìƒì„  ê¸°ëŠ¥í•­ì§„ì¦", searchTerms: ["ê°‘ìƒì„ ", "ê¸°ëŠ¥í•­ì§„", "ê°‘í•­"], code: "E05.9" },
            
            // ìˆœí™˜ê¸°ê³„
            { diagnosis: "ê³ í˜ˆì••", searchTerms: ["ê³ í˜ˆì••", "í˜ˆì••", "ê³ í˜ˆì••ì¦"], code: "I10" },
            { diagnosis: "í˜‘ì‹¬ì¦", searchTerms: ["í˜‘ì‹¬ì¦", "ê°€ìŠ´í†µì¦", "í‰í†µ"], code: "I20.9" },
            { diagnosis: "ë¶€ì •ë§¥", searchTerms: ["ë¶€ì •ë§¥", "ì‹¬ì¥", "ë‘ê·¼ê±°ë¦¼"], code: "I49.9" },
            { diagnosis: "í•˜ì§€ì •ë§¥ë¥˜", searchTerms: ["ì •ë§¥ë¥˜", "í•˜ì§€", "ë‹¤ë¦¬"], code: "I83.9" },
            
            // ì‹ ê²½ê³„ / ì •ì‹ ê³¼
            { diagnosis: "í¸ë‘í†µ", searchTerms: ["í¸ë‘í†µ", "ë‘í†µ", "ë¨¸ë¦¬ì•„í””"], code: "G43.9" },
            { diagnosis: "ê¸´ì¥ì„± ë‘í†µ", searchTerms: ["ê¸´ì¥ì„±", "ë‘í†µ", "ìŠ¤íŠ¸ë ˆìŠ¤"], code: "G44.2" },
            { diagnosis: "ì–´ì§€ëŸ¼ì¦", searchTerms: ["ì–´ì§€ëŸ¼ì¦", "í˜„ê¸°ì¦", "ì–´ì§€ëŸ¬ì›€"], code: "R42" },
            { diagnosis: "ë¶ˆë©´ì¦", searchTerms: ["ë¶ˆë©´ì¦", "ì ", "ìˆ˜ë©´"], code: "F51.0" },
            { diagnosis: "ìš°ìš¸ì¦", searchTerms: ["ìš°ìš¸ì¦", "ìš°ìš¸", "ê¸°ë¶„"], code: "F32.9" },
            { diagnosis: "ë¶ˆì•ˆì¥ì• ", searchTerms: ["ë¶ˆì•ˆ", "ë¶ˆì•ˆì¥ì• ", "ê³µí™©"], code: "F41.9" },
            
            // ê·¼ê³¨ê²©ê³„
            { diagnosis: "ìš”í†µ", searchTerms: ["ìš”í†µ", "í—ˆë¦¬", "í—ˆë¦¬í†µì¦"], code: "M54.5" },
            { diagnosis: "ëª© í†µì¦", searchTerms: ["ëª©í†µì¦", "ê²½ì¶”í†µ", "ëª©", "ì–´ê¹¨"], code: "M54.2" },
            { diagnosis: "ë¬´ë¦ ê´€ì ˆì—¼", searchTerms: ["ë¬´ë¦", "ê´€ì ˆì—¼", "ë¬´ë¦í†µì¦"], code: "M17.9" },
            { diagnosis: "ì–´ê¹¨í†µì¦", searchTerms: ["ì–´ê¹¨", "ì–´ê¹¨í†µì¦", "ì˜¤ì‹­ê²¬"], code: "M75.1" },
            { diagnosis: "í…Œë‹ˆìŠ¤ì—˜ë³´", searchTerms: ["í…Œë‹ˆìŠ¤ì—˜ë³´", "íŒ”ê¿ˆì¹˜", "ì—˜ë³´"], code: "M77.1" },
            { diagnosis: "ì†ëª©í„°ë„ì¦í›„êµ°", searchTerms: ["ì†ëª©", "í„°ë„", "ì†ëª©í†µì¦"], code: "G56.0" },
            
            // í”¼ë¶€ê³¼ / ê°ì—¼ì„±
            { diagnosis: "ëŒ€ìƒí¬ì§„", searchTerms: ["ëŒ€ìƒí¬ì§„", "í¬ì§„", "ë "], code: "B02.9" },
            { diagnosis: "ë‹¨ìˆœí¬ì§„", searchTerms: ["ë‹¨ìˆœí¬ì§„", "í—¤ë¥´í˜ìŠ¤", "ì…ìˆ "], code: "B00.9" },
            { diagnosis: "ì•Œë ˆë¥´ê¸°ì„± í”¼ë¶€ì—¼", searchTerms: ["ì•Œë ˆë¥´ê¸°", "í”¼ë¶€ì—¼", "ìŠµì§„"], code: "L23.9" },
            { diagnosis: "ë‘ë“œëŸ¬ê¸°", searchTerms: ["ë‘ë“œëŸ¬ê¸°", "ê°€ë ¤ì›€", "ë°œì§„"], code: "L50.9" },
            { diagnosis: "ë¬´ì¢€", searchTerms: ["ë¬´ì¢€", "ì¡±ë¶€ë°±ì„ ", "ë°œê°€ë½"], code: "B35.3" },
            
            // ì†Œì•„ê³¼ / ê¸°íƒ€
            { diagnosis: "ê¸‰ì„± ì¥ì—¼", searchTerms: ["ì¥ì—¼", "ì„¤ì‚¬", "ë³µí†µ"], code: "A09" },
            { diagnosis: "ë°”ì´ëŸ¬ìŠ¤ì„± ê°ì—¼", searchTerms: ["ë°”ì´ëŸ¬ìŠ¤", "ê°ì—¼", "ì—´"], code: "B34.9" },
            { diagnosis: "ë°œì—´", searchTerms: ["ë°œì—´", "ì—´", "ê³ ì—´"], code: "R50.9" },
            { diagnosis: "ê¸‰ì„± ì¤‘ì´ì—¼", searchTerms: ["ì¤‘ì´ì—¼", "ê·€", "ê·€í†µì¦"], code: "H66.9" }
        ];

        // ì§„ë‹¨ëª…-ì²˜ë°© ì¡°í•© ë§¤í•‘ ë°ì´í„°
        const diagnosisPrescriptionMapping = {
            "ê¸‰ì„± ë¹„ì¸ë‘ì—¼": ["í´ë¡œí˜ë¼ìŠ¤í‹´", "ì•”ë¸Œë¡ì†”", "í‘¸ë¼ì½œ", "ë¼ë² í”„ë¼ì¡¸", "ì•„ëª©ì‚¬ì‹¤ë¦°"],
            "ê¸‰ì„± ì¸ë‘ì—¼": ["í´ë¡œí˜ë¼ìŠ¤í‹´", "ì•”ë¸Œë¡ì†”", "í‘¸ë¼ì½œ", "ë¼ë² í”„ë¼ì¡¸", "ì•„ëª©ì‚¬ì‹¤ë¦°"],
            "ê¸‰ì„± í¸ë„ì—¼": ["í´ë¡œí˜ë¼ìŠ¤í‹´", "ì•”ë¸Œë¡ì†”", "í‘¸ë¼ì½œ", "ë¼ë² í”„ë¼ì¡¸", "ì•„ëª©ì‚¬ì‹¤ë¦°"],
            "ê¸‰ì„± ê¸°ê´€ì§€ì—¼": ["ì—˜ë„ìŠ¤", "ì„¸íŒŒí´ëŸ¬", "íŠ¸ë¼ë§ˆëŒ", "ë¼ë² í”„ë¼ì¡¸"],
            "ì•Œë ˆë¥´ê¸° ë¹„ì—¼": ["í´ë¡œí˜ë¼ìŠ¤í‹´", "ë ˆë³´ì„¸í‹°ë¦¬ì§„", "ì•”ë¸Œë¡ì†”"],
            "ë¶€ë¹„ë™ì—¼": ["í´ë˜ë¦¬ìŠ¤ë¡œë§ˆì´ì‹ ", "ì„¸íŒŒí´ëŸ¬", "ë¼ë² í”„ë¼ì¡¸"],
            "ì²œì‹": ["ì—˜ë„ìŠ¤", "í´ë¡œí˜ë¼ìŠ¤í‹´", "ë ˆë³´ì„¸í‹°ë¦¬ì§„"],
            "ê¸‰ì„± ìœ„ì¥ì—¼": ["ë¼ë² í”„ë¼ì¡¸", "ì„¸í”½ì‹¬", "ì•”ë¸Œë¡ì†”"],
            "ê¸°ëŠ¥ì„± ì†Œí™”ë¶ˆëŸ‰": ["ê°€ìŠ¤ëª¨í‹´", "ë¬´ì‚¬í”„ë¦¬ë“œ", "ì•Œë§ˆê²Œì´íŠ¸"],
            "ìœ„ì—¼": ["ì—ì†Œë©”í”„ë¼ì¡¸", "ì•Œë§ˆê²Œì´íŠ¸", "ê°€ìŠ¤ëª¨í‹´"],
            "ì—­ë¥˜ì„± ì‹ë„ì—¼": ["ì—ì†Œë©”í”„ë¼ì¡¸", "ì•Œë§ˆê²Œì´íŠ¸", "ê°€ìŠ¤ëª¨í‹´"],
            "ì œ2í˜• ë‹¹ë‡¨ë³‘": ["ë©”íŠ¸í¬ë¥´ë¯¼", "ê¸€ë¦¬ë©”í”¼ë¦¬ë“œ", "ì‹œíƒ€ê¸€ë¦½í‹´"],
            "ê³ ì§€í˜ˆì¦": ["ì•„í† ë¥´ë°”ìŠ¤íƒ€í‹´", "ì—ì œí‹°ë¯¸ë¸Œ"],
            "ê°‘ìƒì„  ê¸°ëŠ¥ì €í•˜ì¦": ["ë ˆë³´í‹°ë¡ì‹ ", "í‹°ë¡ì‚¬ì‹ "],
            "ê°‘ìƒì„  ê¸°ëŠ¥í•­ì§„ì¦": ["ë©”í‹°ë§ˆì¡¸", "í”„ë¡œí”„ë¼ë†€ë¡¤"],
            "ê³ í˜ˆì••": ["ì•”ë¡œë””í•€", "ë¡œì‚¬ë¥´íƒ„", "íˆë“œë¡œí´ë¡œë¡œí‹°ì•„ì§€ë“œ"],
            "í¸ë‘í†µ": ["í”Œë£¨ë‚˜ë¦¬ì§„", "ì´ì†Œë©”íŠ¸í—¤í”„í… ë³µí•©ì œ", "ì•„ë¯¸íŠ¸ë¦¬í”„í‹¸ë¦°"],
            "ê¸´ì¥ì„± ë‘í†µ": ["í”Œë£¨ë‚˜ë¦¬ì§„", "ì´ì†Œë©”íŠ¸í—¤í”„í… ë³µí•©ì œ", "ì•„ë¯¸íŠ¸ë¦¬í”„í‹¸ë¦°"],
            "ì–´ì§€ëŸ¼ì¦": ["ë² íƒ€íˆìŠ¤í‹´", "ë¼ë² í”„ë¼ì¡¸", "ë””ë©˜íˆë“œë¦¬ë„¤ì´íŠ¸"],
            "ë¶ˆë©´ì¦": ["ì¡¸í”¼ë€", "íŠ¸ë¦¬ì•„ì¡¸ëŒ"],
            "ìš°ìš¸ì¦": ["ì—ìŠ¤ì‹œíƒˆë¡œí”„ëŒ", "ë¡œë¼ì œíŒœ"],
            "ë¶ˆì•ˆì¥ì• ": ["ì—ìŠ¤ì‹œíƒˆë¡œí”„ëŒ", "ë¡œë¼ì œíŒœ"],
            "ìš”í†µ": ["íŠ¸ë¼ë§ˆëŒ", "ë±ì‹œë¶€í”„ë¡œíœ", "ì„¸ë ˆì½•ì‹œë¸Œ", "ë¼ë² í”„ë¼ì¡¸"],
            "ëª© í†µì¦": ["íŠ¸ë¼ë§ˆëŒ", "ë±ì‹œë¶€í”„ë¡œíœ", "ì„¸ë ˆì½•ì‹œë¸Œ", "ë¼ë² í”„ë¼ì¡¸"],
            "ë¬´ë¦ ê´€ì ˆì—¼": ["íŠ¸ë¼ë§ˆëŒ", "ë±ì‹œë¶€í”„ë¡œíœ", "ì„¸ë ˆì½•ì‹œë¸Œ", "ë¼ë² í”„ë¼ì¡¸"],
            "ì–´ê¹¨í†µì¦": ["íŠ¸ë¼ë§ˆëŒ", "ë±ì‹œë¶€í”„ë¡œíœ", "ì„¸ë ˆì½•ì‹œë¸Œ", "ë¼ë² í”„ë¼ì¡¸"],
            "í…Œë‹ˆìŠ¤ì—˜ë³´": ["íŠ¸ë¼ë§ˆëŒ", "ë±ì‹œë¶€í”„ë¡œíœ", "ì„¸ë ˆì½•ì‹œë¸Œ", "ë¼ë² í”„ë¼ì¡¸"],
            "ëŒ€ìƒí¬ì§„": ["í•˜ì´ë“œë¡œì½”ë¥´í‹°ì† ì—°ê³ ", "í“¨ì‹œë“œì‚° ì—°ê³ ", "ë¬´í”¼ë¡œì‹  ì—°ê³ "],
            "ë‹¨ìˆœí¬ì§„": ["í•˜ì´ë“œë¡œì½”ë¥´í‹°ì† ì—°ê³ ", "í“¨ì‹œë“œì‚° ì—°ê³ ", "ë¬´í”¼ë¡œì‹  ì—°ê³ "],
            "ì•Œë ˆë¥´ê¸°ì„± í”¼ë¶€ì—¼": ["í´ë¡œí˜ë¼ìŠ¤í‹´", "ë ˆë³´ì„¸í‹°ë¦¬ì§„", "ì•”ë¸Œë¡ì†”"],
            "ë‘ë“œëŸ¬ê¸°": ["í•˜ì´ë“œë¡œì½”ë¥´í‹°ì† ì—°ê³ ", "í“¨ì‹œë“œì‚° ì—°ê³ ", "ë¬´í”¼ë¡œì‹  ì—°ê³ "],
            "ë¬´ì¢€": ["í•˜ì´ë“œë¡œì½”ë¥´í‹°ì† ì—°ê³ ", "í“¨ì‹œë“œì‚° ì—°ê³ ", "ë¬´í”¼ë¡œì‹  ì—°ê³ "],
            "ê¸‰ì„± ì¥ì—¼": ["ë¼ë² í”„ë¼ì¡¸", "ì„¸í”½ì‹¬", "ì•”ë¸Œë¡ì†”"],
            "ë°”ì´ëŸ¬ìŠ¤ì„± ê°ì—¼": ["ì•„ëª©ì‚¬ì‹¤ë¦°", "í´ë˜ë¦¬ìŠ¤ë¡œë§ˆì´ì‹ ", "í‘¸ë¼ì½œ"],
            "ë°œì—´": ["í‘¸ë¼ì½œ", "ì•”ë¸Œë¡ì†”", "ë¼ë² í”„ë¼ì¡¸"],
            "ê¸‰ì„± ì¤‘ì´ì—¼": ["í´ë˜ë¦¬ìŠ¤ë¡œë§ˆì´ì‹ ", "ì„¸íŒŒí´ëŸ¬", "ë¼ë² í”„ë¼ì¡¸"]
        };

        // ì•½ë¬¼ ë°ì´í„° (ì‹¤ì œ ì˜ì›ì—ì„œ ìì£¼ ì‚¬ìš©ë˜ëŠ” ê¸°ì¤€)
        const medicationData = [
    // ê°ê¸° / í˜¸í¡ê¸°
            { name: "í´ë¡œí˜ë¼ìŠ¤í‹´", ingredient: "í´ë¡œí˜ë¼ìŠ¤í‹´ì—¼ì‚°ì—¼", dosage: "10mg", frequency: "1ì¼ 3íšŒ", symptoms: ["ë§ˆë¥¸ê¸°ì¹¨", "ê¸°ì¹¨"], category: "ê°ê¸°/í˜¸í¡ê¸°" },
            { name: "ì•”ë¸Œë¡ì†”", ingredient: "ì•”ë¸Œë¡ì†”ì—¼ì‚°ì—¼", dosage: "30mg", frequency: "1ì¼ 3íšŒ", symptoms: ["ê°€ë˜", "ê¸°ì¹¨ì™„í™”", "ê±°ë‹´"], category: "ê°ê¸°/í˜¸í¡ê¸°" },
            { name: "ì—˜ë„ìŠ¤", ingredient: "ì—ë¥´ë„ìŠ¤í…Œì¸", dosage: "300mg", frequency: "1ì¼ 2íšŒ", symptoms: ["ì§„í•œê°€ë˜", "ì¸í›„ì—¼", "ê±°ë‹´"], category: "ê°ê¸°/í˜¸í¡ê¸°" },
            { name: "í‘¸ë¼ì½œ", ingredient: "ë³µí•©ì œ", dosage: "1ì •", frequency: "1ì¼ 3íšŒ", symptoms: ["ì¢…í•©ê°ê¸°", "í•´ì—´", "ì§„í†µ", "ê¸°ì¹¨"], category: "ê°ê¸°/í˜¸í¡ê¸°" },

            { name: "ì´ì†Œë©”íŠ¸í—¤í”„í… ë³µí•©ì œ", ingredient: "ì´ì†Œë©”íŠ¸í—¤í”„í… + ì¹´í˜ì¸ + ì•„ì„¸íŠ¸ì•„ë¯¸ë…¸íœ", dosage: "1ì •", frequency: "ë‘í†µ ì‹œ 1~2ì •", symptoms: ["í¸ë‘í†µ", "í˜ˆê´€ì„± ë‘í†µ"], category: "ì§„í†µ/ì‹ ê²½" },
            { name: "í”Œë£¨ë‚˜ë¦¬ì§„", ingredient: "í”Œë£¨ë‚˜ë¦¬ì§„ì—¼ì‚°ì—¼", dosage: "5mg", frequency: "1ì¼ 1íšŒ", symptoms: ["í¸ë‘í†µ ì˜ˆë°©"], category: "ì‹ ê²½ê³¼" },
            { name: "ì•„ë¯¸íŠ¸ë¦¬í”„í‹¸ë¦°", ingredient: "ì•„ë¯¸íŠ¸ë¦¬í”„í‹¸ë¦°ì—¼ì‚°ì—¼", dosage: "10~25mg", frequency: "1ì¼ 1íšŒ", symptoms: ["ê¸´ì¥ì„± ë‘í†µ", "ì‹ ê²½í†µ"], category: "ì‹ ê²½ê³¼" },
            { name: "ë² íƒ€íˆìŠ¤í‹´", ingredient: "ë² íƒ€íˆìŠ¤í‹´ë””í•˜ì´ë“œë¡œí´ë¡œë¼ì´ë“œ", dosage: "8mg", frequency: "1ì¼ 3íšŒ", symptoms: ["ì–´ì§€ëŸ¼ì¦", "ì´ëª…"], category: "ì‹ ê²½ê³¼" },
            { name: "ë””ë©˜íˆë“œë¦¬ë„¤ì´íŠ¸", ingredient: "ë””ë©˜íˆë“œë¦¬ë„¤ì´íŠ¸", dosage: "50mg", frequency: "1ì¼ 3íšŒ", symptoms: ["í˜„ê¸°ì¦", "ë©€ë¯¸"], category: "ì‹ ê²½ê³¼" },

    // ë¶ˆë©´ì¦ ê´€ë ¨ (í–¥ì •)
            { name: "ì¡¸í”¼ë€", ingredient: "ì¡¸í”¼ë€íƒ€ë¥´íƒ€ë¥´ì‚°ì—¼", dosage: "5~10mg", frequency: "ì·¨ì¹¨ ì „", symptoms: ["ë¶ˆë©´ì¦"], category: "ì •ì‹ ê³¼/ìˆ˜ë©´" },
            { name: "íŠ¸ë¦¬ì•„ì¡¸ëŒ", ingredient: "íŠ¸ë¦¬ì•„ì¡¸ëŒ", dosage: "0.25mg", frequency: "ì·¨ì¹¨ ì „", symptoms: ["ë¶ˆë©´ì¦"], category: "ì •ì‹ ê³¼/ìˆ˜ë©´" },

    // ë¶ˆì•ˆ/ìš°ìš¸ (í–¥ì •)
            { name: "ì—ìŠ¤ì‹œíƒˆë¡œí”„ëŒ", ingredient: "ì—ìŠ¤ì‹œíƒˆë¡œí”„ëŒì˜¥ì‚´ì‚°ì—¼", dosage: "10mg", frequency: "1ì¼ 1íšŒ", symptoms: ["ìš°ìš¸ì¦", "ë¶ˆì•ˆ"], category: "ì •ì‹ ê³¼" },
            { name: "ë¡œë¼ì œíŒœ", ingredient: "ë¡œë¼ì œíŒœ", dosage: "0.5~1mg", frequency: "1ì¼ 2~3íšŒ í•„ìš”ì‹œ", symptoms: ["ë¶ˆì•ˆ", "ê³µí™©"], category: "ì •ì‹ ê³¼" }, 
            
    // ìœ„ì¥ì•½ / ì†Œí™”ì œ
            { name: "ê°€ìŠ¤ëª¨í‹´", ingredient: "ëª¨ì‚¬í”„ë¦¬ë“œ", dosage: "5mg", frequency: "1ì¼ 3íšŒ", symptoms: ["ì†Œí™”ë¶ˆëŸ‰", "ìœ„ì •ì²´ê°", "ì†ì“°ë¦¼"], category: "ìœ„ì¥ì•½" },
            { name: "ë¬´ì‚¬í”„ë¦¬ë“œ", ingredient: "ë¬´ì‚¬í”„ë¦¬ë“œì‹œíŠ¸ë¥´ì‚°ì—¼", dosage: "5mg", frequency: "1ì¼ 3íšŒ", symptoms: ["ì†Œí™”ë¶ˆëŸ‰"], category: "ìœ„ì¥ì•½" },
            { name: "ë¼ë² í”„ë¼ì¡¸", ingredient: "ë¼ë² í”„ë¼ì¡¸ë‚˜íŠ¸ë¥¨", dosage: "10mg", frequency: "1ì¼ 1íšŒ", symptoms: ["ìœ„ì—¼", "ì‹ë„ì—¼", "ì†ì“°ë¦¼", "ìœ„ì‚°ì—­ë¥˜"], category: "ìœ„ì¥ì•½" },
            { name: "ì—ì†Œë©”í”„ë¼ì¡¸", ingredient: "ì—ì†Œë©”í”„ë¼ì¡¸ë§ˆê·¸ë„¤ìŠ˜", dosage: "20mg", frequency: "1ì¼ 1íšŒ", symptoms: ["ìœ„ì‚°ì—­ë¥˜", "ìœ„ì—¼"], category: "ìœ„ì¥ì•½" },
            { name: "ì•Œë§ˆê²Œì´íŠ¸", ingredient: "ì•Œë§ˆê²Œì´íŠ¸", dosage: "15ml", frequency: "1ì¼ 3íšŒ ì‹í›„", symptoms: ["ìœ„ì‚°ê³¼ë‹¤", "ì†ì“°ë¦¼"], category: "ìœ„ì¥ì•½" },

    // í†µì¦ / ê·¼ê³¨ê²©ê³„
            { name: "ë±ì‹œë¶€í”„ë¡œíœ", ingredient: "ë±ì‹œë¶€í”„ë¡œíœ", dosage: "300mg", frequency: "1ì¼ 3íšŒ", symptoms: ["ê·¼ìœ¡í†µ", "ìš”í†µ"], category: "ì§„í†µ/ì†Œì—¼" },
            { name: "íŠ¸ë¼ë§ˆëŒ", ingredient: "íŠ¸ë¼ë§ˆëŒì—¼ì‚°ì—¼", dosage: "50mg", frequency: "1ì¼ 2~3íšŒ", symptoms: ["ì‹ ê²½í†µ", "ë””ìŠ¤í¬í†µì¦"], category: "ì§„í†µ/ì†Œì—¼" },
            { name: "ì„¸ë ˆì½•ì‹œë¸Œ", ingredient: "ì„¸ë ˆì½•ì‹œë¸Œ", dosage: "200mg", frequency: "1ì¼ 1~2íšŒ", symptoms: ["ê´€ì ˆì—¼", "ë¥˜ë§ˆí‹°ì¦˜"], category: "ì§„í†µ/ì†Œì—¼" },
            { name: "ë¡œë ‰ì‹ ì •", ingredient: "ë¡ì†Œí”„ë¡œíœë‚˜íŠ¸ë¥¨", dosage: "60mg", frequency: "1ì¼ 3íšŒ", symptoms: ["ê¸‰ì„±ê·¼ìœ¡í†µ", "ì—¼ì¢Œ"], category: "ì§„í†µ/ì†Œì—¼" },

    // í•­ìƒì œ
            { name: "ì•„ëª©ì‚¬ì‹¤ë¦°", ingredient: "ì•„ëª©ì‹œì‹¤ë¦°", dosage: "500mg", frequency: "1ì¼ 3íšŒ", symptoms: ["ì¸í›„ì—¼", "í¸ë„ì—¼"], category: "í•­ìƒì œ" },
            { name: "í´ë˜ë¦¬ìŠ¤ë¡œë§ˆì´ì‹ ", ingredient: "í´ë˜ë¦¬ìŠ¤ë¡œë§ˆì´ì‹ ", dosage: "250mg", frequency: "1ì¼ 2íšŒ", symptoms: ["ê¸°ê´€ì§€ì—¼", "íë ´"], category: "í•­ìƒì œ" },
            { name: "ì„¸íŒŒí´ëŸ¬", ingredient: "ì„¸íŒŒí´ëŸ¬", dosage: "250mg", frequency: "1ì¼ 3íšŒ", symptoms: ["ì¤‘ì´ì—¼", "ì¶•ë†ì¦"], category: "í•­ìƒì œ" },
            { name: "ì„¸í”½ì‹¬", ingredient: "ì„¸í”½ì‹¬", dosage: "100mg", frequency: "1ì¼ 2íšŒ", symptoms: ["ìš”ë¡œê°ì—¼", "ìƒê¸°ë„ê°ì—¼"], category: "í•­ìƒì œ" },
            { name: "ë ˆë³´í”Œë¡ì‚¬ì‹ ", ingredient: "ë ˆë³´í”Œë¡ì‚¬ì‹ ", dosage: "500mg", frequency: "1ì¼ 1íšŒ", symptoms: ["íë ´", "ë°©ê´‘ì—¼"], category: "í•­ìƒì œ" },

    // ì•Œë ˆë¥´ê¸° / í”¼ë¶€
            { name: "ë ˆë³´ì„¸í‹°ë¦¬ì§„", ingredient: "ë ˆë³´ì„¸í‹°ë¦¬ì§„ì—¼ì‚°ì—¼", dosage: "5mg", frequency: "1ì¼ 1íšŒ", symptoms: ["ë¹„ì—¼", "ì•„í† í”¼"], category: "ì•Œë ˆë¥´ê¸°" },
            { name: "í•˜ì´ë“œë¡œì½”ë¥´í‹°ì† ì—°ê³ ", ingredient: "í•˜ì´ë“œë¡œì½”ë¥´í‹°ì†", dosage: "ì ëŸ‰", frequency: "1ì¼ 1~2íšŒ ë„í¬", symptoms: ["ìŠµì§„", "í”¼ë¶€ì—¼"], category: "ì™¸ìš©ì œ" },
            { name: "í“¨ì‹œë“œì‚° ì—°ê³ ", ingredient: "í“¨ì‹œë“œì‚°", dosage: "ì ëŸ‰", frequency: "1ì¼ 2~3íšŒ êµ­ì†Œë„í¬", symptoms: ["ìƒì²˜", "ì—¼ì¦"], category: "ì™¸ìš©ì œ" },
            { name: "ë¬´í”¼ë¡œì‹  ì—°ê³ ", ingredient: "ë¬´í”¼ë¡œì‹ ", dosage: "ì ëŸ‰", frequency: "1ì¼ 2~3íšŒ êµ­ì†Œë„í¬", symptoms: ["ì„¸ê· ê°ì—¼", "í”¼ë¶€ì§ˆí™˜"], category: "ì™¸ìš©ì œ" },
        
            // ë‹¹ë‡¨ë³‘
            { name: "ë©”íŠ¸í¬ë¥´ë¯¼", ingredient: "ë©”íŠ¸í¬ë¥´ë¯¼ì—¼ì‚°ì—¼", dosage: "500mg", frequency: "1ì¼ 2~3íšŒ", symptoms: ["í˜ˆë‹¹ì¡°ì ˆ"], category: "ë‚´ë¶„ë¹„" },
            { name: "ê¸€ë¦¬ë©”í”¼ë¦¬ë“œ", ingredient: "ê¸€ë¦¬ë©”í”¼ë¦¬ë“œ", dosage: "1~4mg", frequency: "1ì¼ 1íšŒ", symptoms: ["í˜ˆë‹¹ì¡°ì ˆ"], category: "ë‚´ë¶„ë¹„" },
            { name: "ì‹œíƒ€ê¸€ë¦½í‹´", ingredient: "ì‹œíƒ€ê¸€ë¦½í‹´", dosage: "100mg", frequency: "1ì¼ 1íšŒ", symptoms: ["í˜ˆë‹¹ì¡°ì ˆ"], category: "ë‚´ë¶„ë¹„" },

    // ê³ ì§€í˜ˆì¦
            { name: "ì•„í† ë¥´ë°”ìŠ¤íƒ€í‹´", ingredient: "ì•„í† ë¥´ë°”ìŠ¤íƒ€í‹´ì¹¼ìŠ˜", dosage: "10~20mg", frequency: "1ì¼ 1íšŒ", symptoms: ["ì½œë ˆìŠ¤í…Œë¡¤ ì¡°ì ˆ"], category: "ìˆœí™˜ê¸°" },
            { name: "ì—ì œí‹°ë¯¸ë¸Œ", ingredient: "ì—ì œí‹°ë¯¸ë¸Œ", dosage: "10mg", frequency: "1ì¼ 1íšŒ", symptoms: ["LDL ì½œë ˆìŠ¤í…Œë¡¤ ì €í•˜"], category: "ìˆœí™˜ê¸°" },

    // ê°‘ìƒì„  ê¸°ëŠ¥ì €í•˜ì¦
            { name: "ë ˆë³´í‹°ë¡ì‹ ", ingredient: "ë ˆë³´í‹°ë¡ì‹ ë‚˜íŠ¸ë¥¨", dosage: "50~100Î¼g", frequency: "1ì¼ 1íšŒ ê³µë³µ", symptoms: ["ê°‘ìƒì„  í˜¸ë¥´ëª¬ ë³´ì¶©"], category: "ë‚´ë¶„ë¹„" },

    // ê°‘ìƒì„  ê¸°ëŠ¥í•­ì§„ì¦
            { name: "ë©”í‹°ë§ˆì¡¸", ingredient: "ë©”í‹°ë§ˆì¡¸", dosage: "5~10mg", frequency: "1ì¼ 1~3íšŒ", symptoms: ["ê°‘ìƒì„  ì–µì œ"], category: "ë‚´ë¶„ë¹„" },
            { name: "í”„ë¡œí”„ë¼ë†€ë¡¤", ingredient: "í”„ë¡œí”„ë¼ë†€ë¡¤ì—¼ì‚°ì—¼", dosage: "10~40mg", frequency: "1ì¼ 2~3íšŒ", symptoms: ["ì†ë–¨ë¦¼", "ë‘ê·¼ê±°ë¦¼"], category: "ìˆœí™˜ê¸°" },

    // ê³ í˜ˆì••
            { name: "ì•”ë¡œë””í•€", ingredient: "ì•”ë¡œë””í•€ë² ì‹¤ì‚°ì—¼", dosage: "5mg", frequency: "1ì¼ 1íšŒ", symptoms: ["ê³ í˜ˆì••", "í˜ˆì••ì¡°ì ˆ"], category: "ìˆœí™˜ê¸°" },
            { name: "ë¡œì‚¬ë¥´íƒ„", ingredient: "ë¡œì‚¬ë¥´íƒ„ì¹¼ë¥¨", dosage: "50~100mg", frequency: "1ì¼ 1íšŒ", symptoms: ["ê³ í˜ˆì••", "ì‹¬ì¥ë³´í˜¸"], category: "ìˆœí™˜ê¸°" },
            { name: "íˆë“œë¡œí´ë¡œë¡œí‹°ì•„ì§€ë“œ", ingredient: "íˆë“œë¡œí´ë¡œë¡œí‹°ì•„ì§€ë“œ", dosage: "12.5mg", frequency: "1ì¼ 1íšŒ", symptoms: ["ì´ë‡¨", "ë¶€ì¢…", "í˜ˆì••ì¡°ì ˆ"], category: "ìˆœí™˜ê¸°" }
        ];


        // WebSocket ì—°ê²° ì„¤ì •
        let stompClient = null;
        let isConnected = false;

        function connectWebSocket() {
            // ë™ì  WebSocket URL ì„¤ì •
            const socket = new SockJS('http://192.168.70.26:8081/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                console.log('WebSocket ì—°ê²° ì„±ê³µ:', frame);
                isConnected = true;
                
                // ëŒ€ê¸°ì—´ ì—…ë°ì´íŠ¸ êµ¬ë…
                stompClient.subscribe('/topic/waiting-queue', function(message) {
                    const data = JSON.parse(message.body);
                    console.log('ëŒ€ê¸°ì—´ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ :', data);
                    
                    if (data.type === 'QUEUE_UPDATE') {
                        // ëŒ€ê¸°ì—´ ìë™ ìƒˆë¡œê³ ì¹¨
                        loadWaitingQueue();
                        loadCurrentPatients();
                    }
                });
                
            }, function(error) {
                console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
                console.error('WebSocket ì˜¤ë¥˜ ì„¸ë¶€ ì •ë³´:', {
                    url: window.location.host + '/ws',
                    protocol: window.location.protocol,
                    error: error
                });
                isConnected = false;
                
                // ì¬ì—°ê²° ì‹œë„
                setTimeout(() => {
                    console.log('WebSocket ì¬ì—°ê²° ì‹œë„...');
                    connectWebSocket();
                }, 5000);
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            loadWaitingQueue();
            loadCurrentPatients();
            
            // WebSocket ì—°ê²°
            connectWebSocket();
            
            // í´ë°±: 30ì´ˆë§ˆë‹¤ ëŒ€ê¸°ì—´ ìƒˆë¡œê³ ì¹¨ (WebSocket ì—°ê²° ì‹¤íŒ¨ ì‹œ)
            setInterval(() => {
                if (!isConnected) {
                    loadWaitingQueue();
                    loadCurrentPatients();
                }
            }, 30000);
            
            // ì¬ì§„ ë‚ ì§œ ì„ íƒ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.getElementById('followUpDate').addEventListener('change', function() {
                const customDateInput = document.getElementById('customFollowUpDate');
                if (this.value === 'custom') {
                    customDateInput.classList.remove('hidden');
                } else {
                    customDateInput.classList.add('hidden');
                }
            });

            // ì§„ë‹¨ëª… ê²€ìƒ‰ ìë™ì™„ì„± ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            setupDiagnosisSearch();
            
            // ì•½ë¬¼ ê²€ìƒ‰ ìë™ì™„ì„± ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            setupMedicationSearch();
            
            // ì²« ë²ˆì§¸ ì•½ë¬¼ í–‰ ì¶”ê°€
            addMedicationRow();
            
            // ì²« ë²ˆì§¸ ì§„ë‹¨ëª… í–‰ ì¶”ê°€
            addDiagnosisRow();
        });

        // ========== ì§„ë‹¨ëª… ê²€ìƒ‰ ìë™ì™„ì„± ==========
        
        function setupDiagnosisSearch() {
            const searchInput = document.getElementById('diagnosisSearch');
            const dropdown = document.getElementById('diagnosisDropdown');
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length < 1) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                // ê²€ìƒ‰ ê²°ê³¼ í•„í„°ë§
                const results = diagnosisData.filter(item => {
                    return item.diagnosis.toLowerCase().includes(query) ||
                           item.code.toLowerCase().includes(query) ||
                           item.searchTerms.some(term => term.toLowerCase().includes(query));
                });
                
                displayDiagnosisResults(results);
            });
            
            // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ìˆ¨ê¹€
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.form-group')) {
                    dropdown.style.display = 'none';
                }
            });
        }
        
        function displayDiagnosisResults(results) {
            const dropdown = document.getElementById('diagnosisDropdown');
            
            if (results.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            dropdown.innerHTML = results.map(item => `
                <div class="diagnosis-item" onclick="selectDiagnosis('${item.diagnosis}', '${item.code}')">
                    <span class="diagnosis-name">${item.diagnosis}</span>
                    <span class="diagnosis-code">${item.code}</span>
                </div>
            `).join('');
            
            dropdown.style.display = 'block';
        }
        
        function selectDiagnosis(diagnosis, code) {
            document.getElementById('diagnosisSearch').value = diagnosis;
            document.getElementById('diagnosisCode').value = code;
            document.getElementById('finalDiagnosis').value = diagnosis;
            document.getElementById('diagnosisDropdown').style.display = 'none';
            
            // ìë™ìœ¼ë¡œ ì§„ë‹¨ëª… í…Œì´ë¸”ì— ì¶”ê°€
            addDiagnosisFromSearch();
        }

        // ========== ì•½ë¬¼ ê²€ìƒ‰ ìë™ì™„ì„± ==========
        
        function setupMedicationSearch() {
            const searchInput = document.getElementById('medicationSearch');
            const dropdown = document.getElementById('medicationDropdown');
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length < 1) {
                    dropdown.style.display = 'none';
                    return;
                }
                
                // ê²€ìƒ‰ ê²°ê³¼ í•„í„°ë§
                const results = medicationData.filter(item => {
                    return item.name.toLowerCase().includes(query) ||
                           item.ingredient.toLowerCase().includes(query) ||
                           item.category.toLowerCase().includes(query) ||
                           item.symptoms.some(symptom => symptom.toLowerCase().includes(query));
                });
                
                displayMedicationResults(results);
            });
            
            // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ìˆ¨ê¹€
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.form-group')) {
                    dropdown.style.display = 'none';
                }
            });
        }
        
        function displayMedicationResults(results) {
            const dropdown = document.getElementById('medicationDropdown');
            
            if (results.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            dropdown.innerHTML = results.map(item => `
                <div class="medication-item" onclick="selectMedication('${item.name}', '${item.ingredient}', '${item.dosage}', '${item.frequency}', '${item.category}')">
                    <div class="medication-info">
                        <div class="medication-name">${item.name}</div>
                        <div class="medication-details">${item.ingredient} | ${item.dosage} ${item.frequency}</div>
                        <div class="medication-details">ì ì‘ì¦: ${item.symptoms.join(', ')}</div>
                    </div>
                    <div class="medication-category">${item.category}</div>
                </div>
            `).join('');
            
            dropdown.style.display = 'block';
        }
        
        function selectMedication(name, ingredient, dosage, frequency, category) {
            // ì•½ë¬¼ ê²€ìƒ‰ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('medicationSearch').value = '';
            document.getElementById('medicationDropdown').style.display = 'none';
            
            // ìƒˆë¡œìš´ ì•½ë¬¼ í–‰ì„ ì¶”ê°€í•˜ê³  ì„ íƒëœ ì•½ë¬¼ ì •ë³´ë¡œ ì±„ìš°ê¸°
            addMedicationFromSearch(name, ingredient, dosage, frequency, category);
        }
        
        function addMedicationFromSearch(name, ingredient, dosage, frequency, category) {
            const tableBody = document.getElementById('medicationTableBody');
            const rowCount = tableBody.children.length;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <input type="text" name="medicationName[]" value="${name}" placeholder="ì•½ë¬¼ëª…">
                </td>
                <td>
                    <input type="text" name="dosage[]" value="${dosage}" placeholder="ìš©ëŸ‰ (ì˜ˆ: 500mg)">
                </td>
                <td>
                    <select name="frequency[]">
                        <option value="">ì„ íƒ</option>
                        <option value="1ì¼ 1íšŒ" ${frequency === '1ì¼ 1íšŒ' ? 'selected' : ''}>1ì¼ 1íšŒ</option>
                        <option value="1ì¼ 2íšŒ" ${frequency === '1ì¼ 2íšŒ' ? 'selected' : ''}>1ì¼ 2íšŒ</option>
                        <option value="1ì¼ 3íšŒ" ${frequency === '1ì¼ 3íšŒ' ? 'selected' : ''}>1ì¼ 3íšŒ</option>
                        <option value="1ì¼ 4íšŒ" ${frequency === '1ì¼ 4íšŒ' ? 'selected' : ''}>1ì¼ 4íšŒ</option>
                        <option value="1ì¼ 2-3íšŒ" ${frequency === '1ì¼ 2-3íšŒ' ? 'selected' : ''}>1ì¼ 2-3íšŒ</option>
                        <option value="í•„ìš”ì‹œ" ${frequency === 'í•„ìš”ì‹œ' ? 'selected' : ''}>í•„ìš”ì‹œ</option>
                    </select>
                </td>
                <td>
                    <select name="days[]">
                        <option value="">ì„ íƒ</option>
                        <option value="1ì¼ë¶„">1ì¼ë¶„</option>
                        <option value="2ì¼ë¶„">2ì¼ë¶„</option>
                        <option value="3ì¼ë¶„" selected>3ì¼ë¶„</option>
                        <option value="5ì¼ë¶„">5ì¼ë¶„</option>
                        <option value="7ì¼ë¶„">7ì¼ë¶„</option>
                        <option value="10ì¼ë¶„">10ì¼ë¶„</option>
                        <option value="14ì¼ë¶„">14ì¼ë¶„</option>
                        <option value="30ì¼ë¶„">30ì¼ë¶„</option>
                    </select>
                </td>
                <td>
                    <select name="dosageInstructions[]">
                        <option value="">ì„ íƒ</option>
                        <option value="ì‹ì „ 30ë¶„" ${frequency.includes('ì‹ì „') ? 'selected' : ''}>ì‹ì „ 30ë¶„</option>
                        <option value="ì‹í›„ 30ë¶„" selected>ì‹í›„ 30ë¶„</option>
                        <option value="ì‹ê°„">ì‹ê°„</option>
                        <option value="ì·¨ì¹¨ì „">ì·¨ì¹¨ì „</option>
                        <option value="ì•„ì¹¨ ê³µë³µ">ì•„ì¹¨ ê³µë³µ</option>
                        <option value="í•„ìš”ì‹œ">í•„ìš”ì‹œ</option>
                    </select>
                </td>
                <td>
                    <select name="coverage[]">
                        <option value="ê¸‰ì—¬" selected>ê¸‰ì—¬</option>
                        <option value="ë¹„ê¸‰ì—¬">ë¹„ê¸‰ì—¬</option>
                    </select>
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeMedicationRow(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            `;
            
            tableBody.appendChild(row);
        }

        // ========== ì•½ë¬¼ ì²˜ë°© í…Œì´ë¸” ê´€ë¦¬ ==========
        
        let medicationRowCount = 0;
        let diagnosisRowCount = 0;
        
        function addMedicationRow() {
            const tableBody = document.getElementById('medicationTableBody');
            const rowId = `medication-row-${++medicationRowCount}`;
            
            const row = document.createElement('tr');
            row.id = rowId;
            row.innerHTML = `
                <td><input type="text" name="medicationName[]" placeholder="ì•½ë¬¼ëª… ì…ë ¥ (ê²€ìƒ‰ ê¸°ëŠ¥ í™œìš©)"></td>
                <td><input type="text" name="dosage[]" placeholder="500mg (ìš©ëŸ‰ ì¡°ì • ê°€ëŠ¥)"></td>
                <td>
                    <select name="frequency[]">
                        <option value="">ì„ íƒ</option>
                        <option value="1ì¼ 1íšŒ">1ì¼ 1íšŒ</option>
                        <option value="1ì¼ 2íšŒ">1ì¼ 2íšŒ</option>
                        <option value="1ì¼ 3íšŒ">1ì¼ 3íšŒ</option>
                        <option value="1ì¼ 4íšŒ">1ì¼ 4íšŒ</option>
                        <option value="1ì¼ 2-3íšŒ">1ì¼ 2-3íšŒ</option>
                        <option value="í•„ìš”ì‹œ">í•„ìš”ì‹œ</option>
                    </select>
                </td>
                <td>
                    <select name="days[]">
                        <option value="">ì„ íƒ</option>
                        <option value="1ì¼ë¶„">1ì¼ë¶„</option>
                        <option value="2ì¼ë¶„">2ì¼ë¶„</option>
                        <option value="3ì¼ë¶„">3ì¼ë¶„</option>
                        <option value="5ì¼ë¶„">5ì¼ë¶„</option>
                        <option value="7ì¼ë¶„">7ì¼ë¶„</option>
                        <option value="10ì¼ë¶„">10ì¼ë¶„</option>
                        <option value="14ì¼ë¶„">14ì¼ë¶„</option>
                        <option value="30ì¼ë¶„">30ì¼ë¶„</option>
                    </select>
                </td>
                <td>
                    <select name="dosageInstructions[]">
                        <option value="">ì„ íƒ</option>
                        <option value="ì‹ì „ 30ë¶„">ì‹ì „ 30ë¶„</option>
                        <option value="ì‹í›„ 30ë¶„">ì‹í›„ 30ë¶„</option>
                        <option value="ì‹ê°„">ì‹ê°„</option>
                        <option value="ì·¨ì¹¨ì „">ì·¨ì¹¨ì „</option>
                        <option value="ì•„ì¹¨ ê³µë³µ">ì•„ì¹¨ ê³µë³µ</option>
                        <option value="í•„ìš”ì‹œ">í•„ìš”ì‹œ</option>
                    </select>
                </td>
                <td>
                    <select name="coverage[]">
                        <option value="ê¸‰ì—¬">ê¸‰ì—¬</option>
                        <option value="ë¹„ê¸‰ì—¬">ë¹„ê¸‰ì—¬</option>
                    </select>
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeMedicationRow(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            `;
            
            tableBody.appendChild(row);
        }
        
        function removeMedicationRow(button) {
            const row = button.closest('tr');
            if (row) {
                row.remove();
            }
            
            // ìµœì†Œ 1ê°œ í–‰ì€ ìœ ì§€
            const remainingRows = document.querySelectorAll('#medicationTableBody tr');
            if (remainingRows.length === 0) {
                addMedicationRow();
            }
        }
        
        // ì•½ë¬¼ ì²˜ë°© ë°ì´í„° ìˆ˜ì§‘
        function collectMedicationData() {
            const rows = document.querySelectorAll('#medicationTableBody tr');
            const medications = [];
            
            rows.forEach(row => {
                const name = row.querySelector('input[name="medicationName[]"]').value;
                const dosage = row.querySelector('input[name="dosage[]"]').value;
                const frequency = row.querySelector('select[name="frequency[]"]').value;
                const days = row.querySelector('select[name="days[]"]').value;
                const instructions = row.querySelector('select[name="dosageInstructions[]"]').value;
                const coverage = row.querySelector('select[name="coverage[]"]').value;
                
                if (name.trim()) {
                    medications.push({
                        name: name.trim(),
                        dosage: dosage.trim(),
                        frequency: frequency,
                        days: days,
                        instructions: instructions,
                        coverage: coverage
                    });
                }
            });
            
            return medications;
        }

        // ========== ì§„ë‹¨ëª… ê´€ë¦¬ í•¨ìˆ˜ë“¤ ==========
        function addDiagnosisRow() {
            const tableBody = document.getElementById('diagnosisTableBody');
            const rowId = `diagnosis-row-${++diagnosisRowCount}`;
            
            const row = document.createElement('tr');
            row.id = rowId;
            row.innerHTML = `
                <td><input type="text" name="diagnosisName[]" placeholder="ì§„ë‹¨ëª… ì…ë ¥" readonly></td>
                <td><input type="text" name="diagnosisCode[]" placeholder="ìƒë³‘ì½”ë“œ" readonly></td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeDiagnosisRow('${rowId}')">
                        ì‚­ì œ
                    </button>
                </td>
            `;
            
            tableBody.appendChild(row);
        }

        function removeDiagnosisRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
            }
            
            // í…Œì´ë¸”ì´ ë¹„ì–´ìˆìœ¼ë©´ í•˜ë‚˜ ì¶”ê°€
            const remainingRows = document.querySelectorAll('#diagnosisTableBody tr');
            if (remainingRows.length === 0) {
                addDiagnosisRow();
            }
        }

        function addDiagnosisFromSearch() {
            const diagnosisName = document.getElementById('diagnosisSearch').value;
            const diagnosisCode = document.getElementById('diagnosisCode').value;
            
            if (!diagnosisName.trim()) {
                showAlert('ì§„ë‹¨ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            // ì§„ë‹¨ëª… í…Œì´ë¸”ì— ì¶”ê°€
            addDiagnosisRow();
            const lastRow = document.querySelector('#diagnosisTableBody tr:last-child');
            if (lastRow) {
                lastRow.querySelector('input[name="diagnosisName[]"]').value = diagnosisName;
                lastRow.querySelector('input[name="diagnosisCode[]"]').value = diagnosisCode;
            }
            
            // ì§„ë‹¨ëª…ì— í•´ë‹¹í•˜ëŠ” ì²˜ë°© ì¡°í•©ì´ ìˆëŠ”ì§€ í™•ì¸
            const prescriptionCombination = diagnosisPrescriptionMapping[diagnosisName];
            
            if (prescriptionCombination && prescriptionCombination.length > 0) {
                // ì²˜ë°© ì¡°í•©ì´ ìˆëŠ” ê²½ìš° ìë™ìœ¼ë¡œ ì•½ë¬¼ ì¶”ê°€
                console.log(`${diagnosisName}ì— ëŒ€í•œ ì²˜ë°© ì¡°í•© ì¶”ê°€:`, prescriptionCombination);
                
                // ê¸°ì¡´ ì•½ë¬¼ í…Œì´ë¸” ì´ˆê¸°í™” (ë¹ˆ í–‰ ì œê±°)
                const existingRows = document.querySelectorAll('#medicationTableBody tr');
                existingRows.forEach(row => {
                    const nameInput = row.querySelector('input[name="medicationName[]"]');
                    if (!nameInput.value.trim()) {
                        row.remove();
                    }
                });
                
                // ì²˜ë°© ì¡°í•©ì— ë”°ë¼ ì•½ë¬¼ ìë™ ì¶”ê°€
                prescriptionCombination.forEach(medicationName => {
                    const medicationInfo = medicationData.find(med => med.name === medicationName);
                    if (medicationInfo) {
                        addMedicationFromSearch(
                            medicationInfo.name,
                            medicationInfo.ingredient,
                            medicationInfo.dosage,
                            medicationInfo.frequency,
                            medicationInfo.category
                        );
                    }
                });
                
                showAlert(`${diagnosisName} ì§„ë‹¨ì— ëŒ€í•œ ${prescriptionCombination.length}ê°œ ì•½ë¬¼ì´ ìë™ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            } else {
                // ì²˜ë°© ì¡°í•©ì´ ì—†ëŠ” ê²½ìš° (ë¶ˆë©´ì¦, ìš°ìš¸ì¦ ë“±)
                console.log(`${diagnosisName}ì€ ì²˜ë°© ì¡°í•©ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ì¡´ ê²€ìƒ‰ ë°©ì‹ì„ ì‚¬ìš©í•˜ì„¸ìš”.`);
                showAlert(`${diagnosisName}ì€ ë¯¸ë¦¬ ì •ì˜ëœ ì²˜ë°© ì¡°í•©ì´ ì—†ìŠµë‹ˆë‹¤. ì•½ë¬¼ ê²€ìƒ‰ì„ í†µí•´ ì§ì ‘ ì¶”ê°€í•´ì£¼ì„¸ìš”.`, 'info');
            }
            
            // ê²€ìƒ‰ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('diagnosisSearch').value = '';
            document.getElementById('diagnosisCode').value = '';
        }

        function collectDiagnosisData() {
            const rows = document.querySelectorAll('#diagnosisTableBody tr');
            const diagnoses = [];
            
            rows.forEach(row => {
                const name = row.querySelector('input[name="diagnosisName[]"]').value;
                const code = row.querySelector('input[name="diagnosisCode[]"]').value;
                
                if (name.trim()) {
                    diagnoses.push({
                        name: name.trim(),
                        code: code.trim()
                    });
                }
            });
            
            return diagnoses;
        }

                // ëŒ€ê¸°ì—´ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadWaitingQueue() {
            try {
                const response = await fetch('/api/doctor/waiting-queue');
                const waitingQueue = await response.json();
                
                const queueContainer = document.getElementById('waitingQueue');
                
                // ì‘ë‹µì´ ë°°ì—´ì¸ì§€ í™•ì¸
                if (!Array.isArray(waitingQueue)) {
                    console.error('waitingQueue is not an array:', waitingQueue);
                    queueContainer.innerHTML = '<div class="empty-state"><p>ëŒ€ê¸°ì—´ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p></div>';
                    return;
                }
                
                if (waitingQueue.length === 0) {
                    queueContainer.innerHTML = '<div class="empty-state"><p>ëŒ€ê¸° ì¤‘ì¸ í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                    return;
                }

                queueContainer.innerHTML = waitingQueue.map(reception => `
                    <div class="queue-item">
                        <div>
                            <strong>${reception.patientName}</strong>
                        </div>
                        <div>
                            <span class="badge">ëŒ€ê¸°ì¤‘</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('ëŒ€ê¸°ì—´ ë¡œë“œ ì‹¤íŒ¨:', error);
                const queueContainer = document.getElementById('waitingQueue');
                queueContainer.innerHTML = '<div class="empty-state"><p>ëŒ€ê¸°ì—´ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p></div>';
            }
        }

        // í˜„ì¬ ì§„ë£Œ ì¤‘ì¸ í™˜ì ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadCurrentPatients() {
            try {
                const response = await fetch('/api/doctor/current-patients');
                const currentPatients = await response.json();
                
                const container = document.getElementById('currentPatients');
                
                // ì‘ë‹µì´ ë°°ì—´ì¸ì§€ í™•ì¸
                if (!Array.isArray(currentPatients)) {
                    console.error('currentPatients is not an array:', currentPatients);
                    container.innerHTML = '<div class="empty-state"><p>ì§„ë£Œ ì¤‘ì¸ í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                    return;
                }
                
                if (currentPatients.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>ì§„ë£Œ ì¤‘ì¸ í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                    return;
                }

                container.innerHTML = currentPatients.map(patient => `
                    <div class="queue-item current">
                        <div onclick="selectPatient(${patient.patientId}, ${patient.currentReceptionId})" style="cursor: pointer; flex: 1;">
                            <strong>${patient.name}</strong><br>
                            <small>í˜¸ì¶œì‹œê°„: ${patient.currentReception && patient.currentReception.calledAt ? new Date(patient.currentReception.calledAt).toLocaleString() : 'ì •ë³´ ì—†ìŒ'}</small>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span class="badge">ì§„ë£Œì¤‘</span>
                            <button onclick="deleteCurrentPatient(${patient.currentReceptionId}, '${patient.name}')" 
                                    class="btn btn-danger" 
                                    style="font-size: 0.7rem; padding: 0.2rem 0.5rem; margin-left: 0.5rem;"
                                    title="ì§„ë£Œ ì¤‘ì¸ í™˜ì ì‚­ì œ">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('í˜„ì¬ í™˜ì ë¡œë“œ ì‹¤íŒ¨:', error);
                const container = document.getElementById('currentPatients');
                container.innerHTML = '<div class="empty-state"><p>í˜„ì¬ í™˜ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p></div>';
            }
        }

        // í™˜ì í˜¸ì¶œ ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•œ í”Œë˜ê·¸
        let isCallingPatient = false;

        // ë‹¤ìŒ í™˜ì í˜¸ì¶œ
        async function callNextPatient() {
            // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
            if (isCallingPatient) {
                showAlert('ì´ë¯¸ í™˜ìë¥¼ í˜¸ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            // í˜¸ì¶œ ë²„íŠ¼ ë¹„í™œì„±í™”
            isCallingPatient = true;
            const callButton = document.querySelector('button[onclick="callNextPatient()"]');
            if (callButton) {
                callButton.disabled = true;
                callButton.textContent = 'í˜¸ì¶œ ì¤‘...';
            }
            
            try {
                const response = await fetch('/api/doctor/call-next', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'í™˜ì í˜¸ì¶œ ì‹¤íŒ¨');
                }
                
                const patientInfo = await response.json();
                
                // currentReception ì„¤ì •
                currentReception = patientInfo.currentReception;
                console.log('í™˜ì í˜¸ì¶œ í›„ currentReception ì„¤ì •ë¨:', currentReception);
                
                // í˜„ì¬ ì ‘ìˆ˜ ID ì„¤ì • (ì²˜ë°©ì „ ì €ì¥ì— í•„ìš”)
                if (currentReception && currentReception.id) {
                    patientInfo.currentReceptionId = currentReception.id;
                }
                
                showPatientInfo(patientInfo);
                showAlert(`${patientInfo.name}ë‹˜ì´ í˜¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                
                // ëŒ€ê¸°ì—´ê³¼ í˜„ì¬ í™˜ì ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadWaitingQueue();
                loadCurrentPatients();
                
            } catch (error) {
                console.error('í™˜ì í˜¸ì¶œ ì‹¤íŒ¨:', error);
                showAlert('í™˜ì í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ' + error.message, 'error');
            } finally {
                // í˜¸ì¶œ ì™„ë£Œ í›„ ë²„íŠ¼ ì¬í™œì„±í™” (ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ ì‹¤í–‰)
                isCallingPatient = false;
                if (callButton) {
                    callButton.disabled = false;
                    callButton.textContent = 'ë‹¤ìŒ í™˜ì í˜¸ì¶œ';
                }
            }
        }

        // í™˜ì ì„ íƒ (ì§„ë£Œ ì¤‘ì¸ í™˜ì í´ë¦­ ì‹œ)
        async function selectPatient(patientId, receptionId) {
            try {
                console.log('í™˜ì ì„ íƒ:', patientId, 'ì ‘ìˆ˜ ID:', receptionId);
                const response = await fetch(`/api/doctor/patient/${patientId}`);
                const patientInfo = await response.json();
                
                // í˜„ì¬ ì ‘ìˆ˜ ID ì„¤ì •
                patientInfo.currentReceptionId = receptionId;
                
                // currentReception ê°ì²´ ìƒì„± (ì§„ë£Œ ì™„ë£Œì— í•„ìš”)
                currentReception = {
                    id: receptionId,
                    patientId: patientId
                };
                
                console.log('currentReception ì„¤ì •ë¨:', currentReception);
                showPatientInfo(patientInfo);
                
                // ê¸°ì¡´ ì²˜ë°©ì „ì´ ìˆëŠ”ì§€ í™•ì¸
                await checkExistingPrescription(receptionId);
            } catch (error) {
                console.error('í™˜ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                showAlert('í™˜ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // í™˜ì ì •ë³´ í‘œì‹œ
        function showPatientInfo(patientInfo) {
            currentPatient = patientInfo;
            
            // currentReceptionì´ ì´ë¯¸ ì„¤ì •ë˜ì§€ ì•Šì•˜ë‹¤ë©´ patientInfoì—ì„œ ê°€ì ¸ì˜¤ê¸°
            if (!currentReception && patientInfo.currentReception) {
                currentReception = patientInfo.currentReception;
            }
            
            console.log('showPatientInfo - currentPatient:', currentPatient);
            console.log('showPatientInfo - currentReception:', currentReception);
            
            // ë¹ˆ ìƒíƒœ ìˆ¨ê¸°ê¸°
            document.getElementById('emptyState').classList.add('hidden');
            
            // í™˜ì ì •ë³´ í‘œì‹œ (ê¸°ì¡´)
            document.getElementById('patientInfo').classList.remove('hidden');
            document.getElementById('patientName').textContent = patientInfo.name;
            document.getElementById('patientBirthDate').textContent = patientInfo.birthDate;
            document.getElementById('patientPhone').textContent = patientInfo.phoneNumber || 'ë¯¸ë“±ë¡';
            
            // EMR ê¸°ë³¸ ì •ë³´ í‘œì‹œ
            document.getElementById('emrPatientName').textContent = patientInfo.name;
            document.getElementById('emrPatientBirth').textContent = patientInfo.birthDate;
            document.getElementById('emrVisitDate').textContent = new Date().toLocaleDateString('ko-KR');
            
                            // í˜„ì¬ ì ‘ìˆ˜ ID ì„¤ì •
                const receptionId = patientInfo.currentReceptionId || (currentReception ? currentReception.id : null);
                console.log('showPatientInfo - receptionId ì„¤ì •:', {
                    'patientInfo.currentReceptionId': patientInfo.currentReceptionId,
                    'currentReception.id': currentReception ? currentReception.id : null,
                    'final receptionId': receptionId
                });
                
                if (receptionId) {
                    document.getElementById('currentReceptionId').value = receptionId;
                    console.log('currentReceptionId input í•„ë“œì— ì„¤ì •ë¨:', receptionId);
                } else {
                    console.warn('receptionIdê°€ nullì´ê±°ë‚˜ undefinedì…ë‹ˆë‹¤.');
                }
            
            // ë¬¸ì§„í‘œ ì •ë³´ í‘œì‹œ
            if (patientInfo.latestSurvey) {
                console.log('ë¬¸ì§„í‘œ ì •ë³´ í‘œì‹œ:', patientInfo.latestSurvey);
                document.getElementById('surveyInfo').classList.remove('hidden');
                document.getElementById('visitReason').textContent = patientInfo.latestSurvey.visitReason || '-';
                document.getElementById('symptoms').textContent = patientInfo.latestSurvey.symptoms || '-';
                document.getElementById('allergies').textContent = patientInfo.latestSurvey.allergies || '-';
                document.getElementById('medications').textContent = patientInfo.latestSurvey.medications || '-';
                document.getElementById('medicalHistory').textContent = patientInfo.latestSurvey.medicalHistory || '-';
                
                // ë¬¸ì§„í‘œ ì •ë³´ë¥¼ SOAPì˜ S(ì£¼ê´€ì  ì†Œê²¬)ì— ìë™ ì…ë ¥
                const subjectiveText = [];
                const survey = patientInfo.latestSurvey;
                if (survey.visitReason) subjectiveText.push(`ë‚´ì›ì‚¬ìœ : ${survey.visitReason}`);
                if (survey.symptoms) subjectiveText.push(`ì¦ìƒ: ${survey.symptoms}`);
                if (survey.allergies && survey.allergies !== 'ì—†ìŒ') subjectiveText.push(`ì•Œë ˆë¥´ê¸°: ${survey.allergies}`);
                if (survey.medications && survey.medications !== 'ì—†ìŒ') subjectiveText.push(`ë³µìš©ì•½ë¬¼: ${survey.medications}`);
                if (survey.medicalHistory && survey.medicalHistory !== 'ì—†ìŒ') subjectiveText.push(`ê³¼ê±°ë³‘ë ¥: ${survey.medicalHistory}`);
                
                document.getElementById('subjective').value = subjectiveText.join('\n');
            } else {
                console.log('ë¬¸ì§„í‘œ ì •ë³´ ì—†ìŒ');
                document.getElementById('surveyInfo').classList.add('hidden');
            }
            
            // ë°”ì´íƒˆì‚¬ì¸ ì •ë³´ ë¡œë“œ ë° í‘œì‹œ
            const currentReceptionId = patientInfo.currentReceptionId || (currentReception ? currentReception.id : null);
            if (currentReceptionId) {
                loadVitalSignInfo(currentReceptionId);
            } else {
                document.getElementById('vitalSignInfo').classList.add('hidden');
            }
            
            // ì•½ë¬¼ í…Œì´ë¸” ì´ˆê¸°í™” ë° ì²« ë²ˆì§¸ í–‰ ì¶”ê°€
            document.getElementById('medicationTableBody').innerHTML = '';
            addMedicationRow();
            
            // ì§„ë‹¨ëª… í…Œì´ë¸” ì´ˆê¸°í™” ë° ì²« ë²ˆì§¸ í–‰ ì¶”ê°€
            document.getElementById('diagnosisTableBody').innerHTML = '';
            addDiagnosisRow();
            
            // ì²˜ë°©ì „ í¼ í‘œì‹œ
            document.getElementById('prescriptionForm').classList.remove('hidden');
            prescriptionSaved = false;
            
            // ì§„ë£Œ ì™„ë£Œ ë²„íŠ¼ ë¹„í™œì„±í™”
            const completeBtn = document.getElementById('completeBtn');
            if (completeBtn) {
                completeBtn.disabled = true;
                completeBtn.style.backgroundColor = '#6c757d';
                completeBtn.style.cursor = 'not-allowed';
                completeBtn.style.opacity = '0.6';
            }
        }

        // ê¸°ì¡´ ì²˜ë°©ì „ í™•ì¸
        async function checkExistingPrescription(receptionId) {
            try {
                const response = await fetch(`/api/doctor/prescriptions/reception/${receptionId}`);
                if (response.ok) {
                    const prescription = await response.json();
                    // ê¸°ì¡´ ì²˜ë°©ì „ìœ¼ë¡œ í¼ ì±„ìš°ê¸°
                    fillPrescriptionForm(prescription);
                    prescriptionSaved = true;
                    
                    // ì§„ë£Œ ì™„ë£Œ ë²„íŠ¼ í™œì„±í™”
                    const completeBtn = document.getElementById('completeBtn');
                    if (completeBtn) {
                        completeBtn.disabled = false;
                        completeBtn.style.backgroundColor = '#28a745';
                        completeBtn.style.cursor = 'pointer';
                        completeBtn.style.opacity = '1';
                    }
                    
                    showAlert('ê¸°ì¡´ ì²˜ë°©ì „ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ ë‹¤ì‹œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'success');
                }
            } catch (error) {
                // ì²˜ë°©ì „ì´ ì—†ëŠ” ê²½ìš°ëŠ” ì •ìƒ ìƒí™©
                console.log('ì²˜ë°©ì „ ì—†ìŒ - ìƒˆë¡œ ì‘ì„±');
            }
        }
        
        // ë°”ì´íƒˆì‚¬ì¸ ì •ë³´ ë¡œë“œ
        async function loadVitalSignInfo(receptionId) {
            try {
                const response = await fetch(`/api/doctor/vital-sign/${receptionId}`);
                if (response.ok) {
                    const vitalSign = await response.json();
                    displayVitalSignInfo(vitalSign);
                } else {
                    // ë°”ì´íƒˆì‚¬ì¸ì´ ì—†ëŠ” ê²½ìš°
                    displayVitalSignInfo(null);
                    console.log('ë°”ì´íƒˆì‚¬ì¸ ì •ë³´ ì—†ìŒ');
                }
            } catch (error) {
                console.error('ë°”ì´íƒˆì‚¬ì¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                displayVitalSignInfo(null);
            }
        }
        
        // ë°”ì´íƒˆì‚¬ì¸ ì •ë³´ í‘œì‹œ
        function displayVitalSignInfo(vitalSign) {
            const vitalSignInfoElement = document.getElementById('vitalSignInfo');
            
            if (!vitalSign || !vitalSign.id) {
                // ë°”ì´íƒˆì‚¬ì¸ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
                vitalSignInfoElement.classList.remove('hidden');
                
                // ëª¨ë“  í•„ë“œë¥¼ "ì¸¡ì • ì•ˆë¨"ìœ¼ë¡œ í‘œì‹œ
                document.getElementById('vitalBodyTemp').textContent = 'ì¸¡ì • ì•ˆë¨';
                document.getElementById('vitalBloodPressure').textContent = 'ì¸¡ì • ì•ˆë¨';
                document.getElementById('vitalPulse').textContent = 'ì¸¡ì • ì•ˆë¨';
                document.getElementById('vitalSymptoms').textContent = 'ê¸°ë¡ ì—†ìŒ';
                document.getElementById('vitalOtherSymptoms').textContent = 'ê¸°ë¡ ì—†ìŒ';
                document.getElementById('vitalMedicalHistory').textContent = 'ê¸°ë¡ ì—†ìŒ';
                document.getElementById('vitalNurseNotes').textContent = 'ê¸°ë¡ ì—†ìŒ';
                document.getElementById('vitalNurseId').textContent = '-';
                
                console.log('ë°”ì´íƒˆì‚¬ì¸ ë°ì´í„° ì—†ìŒ - ê¸°ë³¸ê°’ìœ¼ë¡œ í‘œì‹œ');
                return;
            }
            
            // ë°”ì´íƒˆì‚¬ì¸ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°
            vitalSignInfoElement.classList.remove('hidden');
            
            // ë°”ì´íƒˆì‚¬ì¸ ìˆ˜ì¹˜ í‘œì‹œ
            document.getElementById('vitalBodyTemp').textContent = vitalSign.bodyTemp ? `${vitalSign.bodyTemp}Â°C` : '-';
            document.getElementById('vitalBloodPressure').textContent = vitalSign.bloodPressure || '-';
            document.getElementById('vitalPulse').textContent = vitalSign.pulse ? `${vitalSign.pulse}bpm` : '-';
            
            // ì¦ìƒ ë° ê³¼ê±°ë ¥ í‘œì‹œ
            document.getElementById('vitalSymptoms').textContent = vitalSign.symptoms || '-';
            document.getElementById('vitalOtherSymptoms').textContent = vitalSign.otherSymptoms || '-';
            document.getElementById('vitalMedicalHistory').textContent = vitalSign.medicalHistory || '-';
            document.getElementById('vitalNurseNotes').textContent = vitalSign.nurseNotes || '-';
            document.getElementById('vitalNurseId').textContent = vitalSign.nurseId || '-';
            
            // ë°”ì´íƒˆì‚¬ì¸ ì •ë³´ë¥¼ SOAPì˜ O(ê°ê´€ì  ì†Œê²¬)ì— ìë™ ì…ë ¥
            const objectiveText = [];
            if (vitalSign.bodyTemp) objectiveText.push(`ì²´ì˜¨: ${vitalSign.bodyTemp}Â°C`);
            if (vitalSign.bloodPressure) objectiveText.push(`í˜ˆì••: ${vitalSign.bloodPressure}`);
            if (vitalSign.pulse) objectiveText.push(`ë§¥ë°•: ${vitalSign.pulse}bpm`);
            
            // ê¸°ì¡´ ê°ê´€ì  ì†Œê²¬ì— ë°”ì´íƒˆì‚¬ì¸ ì¶”ê°€
            const existingObjective = document.getElementById('objective').value;
            const combinedObjective = objectiveText.length > 0 
                ? (existingObjective ? `${existingObjective}\n\n[ë°”ì´íƒˆì‚¬ì¸]\n${objectiveText.join(', ')}` : `[ë°”ì´íƒˆì‚¬ì¸]\n${objectiveText.join(', ')}`)
                : existingObjective;
            
            document.getElementById('objective').value = combinedObjective;
        }

        // ì²˜ë°©ì „ í¼ ì±„ìš°ê¸° (EMR í˜•ì‹)
        function fillPrescriptionForm(prescription) {
            // ì§„ë‹¨ëª… ì„¤ì •
            if (prescription.diagnosis) {
                document.getElementById('diagnosisSearch').value = prescription.diagnosis;
                document.getElementById('finalDiagnosis').value = prescription.diagnosis;
                
                // ì§„ë‹¨ëª… í…Œì´ë¸” ì´ˆê¸°í™”
                document.getElementById('diagnosisTableBody').innerHTML = '';
                
                // ì§„ë‹¨ëª…ì„ ì‰¼í‘œë¡œ ë¶„ë¦¬í•˜ì—¬ í…Œì´ë¸”ì— ì¶”ê°€
                const diagnosisNames = prescription.diagnosis.split(',').map(d => d.trim());
                diagnosisNames.forEach(diagnosisName => {
                    if (diagnosisName) {
                        addDiagnosisRow();
                        const lastRow = document.querySelector('#diagnosisTableBody tr:last-child');
                        if (lastRow) {
                            lastRow.querySelector('input[name="diagnosisName[]"]').value = diagnosisName;
                            
                            // ìƒë³‘ì½”ë“œ ìë™ ì°¾ê¸°
                            const diagnosisItem = diagnosisData.find(item => 
                                item.diagnosis === diagnosisName
                            );
                            if (diagnosisItem) {
                                lastRow.querySelector('input[name="diagnosisCode[]"]').value = diagnosisItem.code;
                            }
                        }
                    }
                });
                
                // í…Œì´ë¸”ì´ ë¹„ì–´ìˆìœ¼ë©´ í•˜ë‚˜ ì¶”ê°€
                if (document.querySelectorAll('#diagnosisTableBody tr').length === 0) {
                    addDiagnosisRow();
                }
            }
            
            // SOAP ì •ë³´ ì„¤ì •
            document.getElementById('subjective').value = prescription.symptoms || '';
            
            // ì¹˜ë£Œ ê³„íšì—ì„œ SOAP ì •ë³´ ë¶„ë¦¬
            if (prescription.treatmentPlan) {
                const lines = prescription.treatmentPlan.split('\n');
                lines.forEach(line => {
                    if (line.startsWith('O: ')) {
                        document.getElementById('objective').value = line.substring(3);
                    } else if (line.startsWith('A: ')) {
                        document.getElementById('assessment').value = line.substring(3);
                    } else if (line.startsWith('P: ')) {
                        document.getElementById('plan').value = line.substring(3);
                    }
                });
            }
            
            // ë³µì•½ì§€ë„ ë° ì˜ì‚¬ ì†Œê²¬
            document.getElementById('medicationGuidance').value = prescription.dosageInstructions || '';
            document.getElementById('doctorNotes').value = prescription.notes || '';
            
            // ì•½ë¬¼ ì²˜ë°© íŒŒì‹± (ê°„ë‹¨í•œ í˜•íƒœë¡œ)
            if (prescription.medications) {
                const medicationLines = prescription.medications.split('\n');
                document.getElementById('medicationTableBody').innerHTML = '';
                
                medicationLines.forEach(line => {
                    if (line.trim()) {
                        addMedicationRow();
                        const lastRow = document.querySelector('#medicationTableBody tr:last-child');
                        if (lastRow) {
                            lastRow.querySelector('input[name="medicationName[]"]').value = line.trim();
                        }
                    }
                });
            }
            
            // ì¬ì§„ ë‚ ì§œ
            if (prescription.followUpDate) {
                document.getElementById('customFollowUpDate').value = new Date(prescription.followUpDate).toISOString().slice(0, 16);
                document.getElementById('followUpDate').value = 'custom';
                document.getElementById('customFollowUpDate').classList.remove('hidden');
            }
        }

        // ì²˜ë°©ì „ ì €ì¥
        async function savePrescription() {
            try {
                // ì €ì¥ ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
                const saveBtn = document.querySelector('button[onclick="savePrescription()"]');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'ì €ì¥ ì¤‘...';
                }
                
                const formData = new FormData(document.getElementById('prescriptionFormData'));
                
                // ì¬ì§„ ë‚ ì§œ ê³„ì‚°
                let followUpDate = null;
                const followUpSelection = formData.get('followUpDate');
                
                if (followUpSelection === 'custom') {
                    const customDate = formData.get('customFollowUpDate');
                    if (customDate) {
                        followUpDate = new Date(customDate).toISOString();
                    }
                } else if (followUpSelection) {
                    const now = new Date();
                    switch (followUpSelection) {
                        case '3days':
                            now.setDate(now.getDate() + 3);
                            break;
                        case '1week':
                            now.setDate(now.getDate() + 7);
                            break;
                        case '2weeks':
                            now.setDate(now.getDate() + 14);
                            break;
                        case '1month':
                            now.setMonth(now.getMonth() + 1);
                            break;
                        case '2months':
                            now.setMonth(now.getMonth() + 2);
                            break;
                        case '3months':
                            now.setMonth(now.getMonth() + 3);
                            break;
                    }
                    // ê¸°ë³¸ì ìœ¼ë¡œ ì˜¤ì „ 10ì‹œë¡œ ì„¤ì •
                    now.setHours(10, 0, 0, 0);
                    followUpDate = now.toISOString();
                }
                
                // ì•½ë¬¼ ì²˜ë°© ë°ì´í„° ìˆ˜ì§‘
                const medications = collectMedicationData();
                const medicationText = medications.map(med => {
                    let text = `${med.name}`;
                    if (med.dosage) text += ` ${med.dosage}`;
                    if (med.frequency) text += ` - ${med.frequency}`;
                    if (med.days) text += `, ${med.days}`; // 'ì¼ë¶„' ì¶”ê°€í•˜ì§€ ì•ŠìŒ
                    if (med.instructions) text += `, ${med.instructions}`;
                    if (med.coverage) text += ` (${med.coverage})`;
                    return text;
                }).join('\n');

                // ì§„ë‹¨ëª… ë°ì´í„° ìˆ˜ì§‘
                const diagnoses = collectDiagnosisData();
                const diagnosisText = diagnoses.map(diag => diag.name).join(', ');

                console.log('ì²˜ë°©ì „ ì €ì¥ - FormData ê²€ì‚¬:', {
                    'formData.get("receptionId")': formData.get('receptionId'),
                    'currentReceptionId input value': document.getElementById('currentReceptionId').value,
                    'currentReception': currentReception
                });
                
                const prescriptionData = {
                    receptionId: parseInt(formData.get('receptionId')),
                    diagnosis: diagnosisText || formData.get('diagnosis') || document.getElementById('finalDiagnosis').value,
                    symptoms: formData.get('subjective') || '', // SOAPì˜ S
                    treatmentPlan: [
                        formData.get('objective') ? `O: ${formData.get('objective')}` : '',
                        formData.get('assessment') ? `A: ${formData.get('assessment')}` : '',
                        formData.get('plan') ? `P: ${formData.get('plan')}` : ''
                    ].filter(Boolean).join('\n'),
                    medications: medicationText || 'ì²˜ë°© ì—†ìŒ',
                    dosageInstructions: formData.get('medicationGuidance') || '',
                    notes: formData.get('doctorNotes') || '',
                    followUpDate: followUpDate
                };

                console.log('ì²˜ë°©ì „ ì €ì¥ ë°ì´í„°:', prescriptionData);
                console.log('currentReception:', currentReception);

                // í•„ìˆ˜ í•„ë“œ ê²€ì¦
                if (!prescriptionData.diagnosis || prescriptionData.diagnosis.trim() === '') {
                    showAlert('ì§„ë‹¨ëª…ì€ í•„ìˆ˜ ì…ë ¥ ì‚¬í•­ì…ë‹ˆë‹¤. ì§„ë‹¨ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    // ì§„ë‹¨ëª… ì…ë ¥ í•„ë“œë¡œ í¬ì»¤ìŠ¤ ì´ë™
                    const diagnosisInput = document.getElementById('diagnosisSearch');
                    if (diagnosisInput) {
                        diagnosisInput.focus();
                    }
                    return;
                }

                // receptionId ê²€ì¦ ë° ë³µêµ¬
                if (!prescriptionData.receptionId || isNaN(prescriptionData.receptionId)) {
                    console.error('receptionIdê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:', prescriptionData.receptionId);
                    
                    // ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ receptionId ë³µêµ¬ ì‹œë„
                    let recoveredReceptionId = null;
                    
                    // 1. currentReceptionì—ì„œ ê°€ì ¸ì˜¤ê¸°
                    if (currentReception && currentReception.id) {
                        recoveredReceptionId = currentReception.id;
                        console.log('currentReceptionì—ì„œ receptionId ë³µêµ¬:', recoveredReceptionId);
                    }
                    
                    // 2. hidden input í•„ë“œì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ê¸°
                    if (!recoveredReceptionId) {
                        const hiddenInput = document.getElementById('currentReceptionId');
                        if (hiddenInput && hiddenInput.value) {
                            recoveredReceptionId = parseInt(hiddenInput.value);
                            console.log('hidden inputì—ì„œ receptionId ë³µêµ¬:', recoveredReceptionId);
                        }
                    }
                    
                    if (recoveredReceptionId && !isNaN(recoveredReceptionId)) {
                        prescriptionData.receptionId = recoveredReceptionId;
                        console.log('receptionId ë³µêµ¬ ì„±ê³µ:', prescriptionData.receptionId);
                    } else {
                        console.error('receptionId ë³µêµ¬ ì‹¤íŒ¨ - ëª¨ë“  ë°©ë²• ì‹œë„í–ˆì§€ë§Œ ì‹¤íŒ¨');
                        showAlert('í™˜ì ì •ë³´ë¥¼ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”. (receptionId ë³µêµ¬ ì‹¤íŒ¨)', 'error');
                        return;
                    }
                }

                const response = await fetch('/api/doctor/prescriptions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(prescriptionData)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('ì²˜ë°©ì „ ì €ì¥ ì‹¤íŒ¨ ì‘ë‹µ:', errorText);
                    
                    let errorMessage = 'ì²˜ë°©ì „ ì €ì¥ ì‹¤íŒ¨';
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.message || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                prescriptionSaved = true;
                
                // ì§„ë£Œ ì™„ë£Œ ë²„íŠ¼ í™œì„±í™”
                const completeBtn = document.getElementById('completeBtn');
                if (completeBtn) {
                    completeBtn.disabled = false;
                    completeBtn.style.backgroundColor = '#28a745';
                    completeBtn.style.cursor = 'pointer';
                    completeBtn.style.opacity = '1';
                }
                
                console.log('ì²˜ë°©ì „ ì €ì¥ ì™„ë£Œ - ì§„ë£Œ ì™„ë£Œ ë²„íŠ¼ í™œì„±í™”ë¨');
                showAlert('ì²˜ë°©ì „ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                
            } catch (error) {
                console.error('ì²˜ë°©ì „ ì €ì¥ ì‹¤íŒ¨:', error);
                showAlert('ì²˜ë°©ì „ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ' + error.message, 'error');
            } finally {
                // ì €ì¥ ë²„íŠ¼ ì¬í™œì„±í™”
                const saveBtn = document.querySelector('button[onclick="savePrescription()"]');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'ì²˜ë°©ì „ ì €ì¥';
                }
            }
        }

        // ì²˜ë°©ì „ ë¯¸ë¦¬ë³´ê¸°
        function previewPrescription() {
            const formData = new FormData(document.getElementById('prescriptionFormData'));
            
            // ì¬ì§„ ë‚ ì§œ í…ìŠ¤íŠ¸ ìƒì„±
            let followUpText = 'í•´ë‹¹ ì—†ìŒ';
            const followUpSelection = formData.get('followUpDate');
            
            if (followUpSelection === 'custom') {
                const customDate = formData.get('customFollowUpDate');
                if (customDate) {
                    followUpText = new Date(customDate).toLocaleDateString('ko-KR', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }
            } else if (followUpSelection) {
                const followUpLabels = {
                    '3days': '3ì¼ í›„',
                    '1week': '1ì£¼ì¼ í›„',
                    '2weeks': '2ì£¼ì¼ í›„',
                    '1month': '1ê°œì›” í›„',
                    '2months': '2ê°œì›” í›„',
                    '3months': '3ê°œì›” í›„'
                };
                followUpText = followUpLabels[followUpSelection] || 'í•´ë‹¹ ì—†ìŒ';
            }
            
            // ê¸°ë³¸ ì •ë³´ ì„¤ì •
            document.getElementById('prescriptionDate').textContent = new Date().toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // í™˜ì ì •ë³´ ì„¤ì •
            if (currentPatient) {
                document.getElementById('previewPatientName').textContent = currentPatient.name;
                document.getElementById('previewPatientBirth').textContent = currentPatient.birthDate;
            }
            
            // ì§„ë‹¨ëª… ì„¤ì • (ì§„ë‹¨ëª… í…Œì´ë¸”ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
            const diagnoses = collectDiagnosisData();
            const diagnosisValue = diagnoses.length > 0 ? 
                                 diagnoses.map(diag => diag.name).join(', ') :
                                 formData.get('diagnosis') || 
                                 document.getElementById('finalDiagnosis').value || 
                                 document.getElementById('diagnosisSearch').value || 
                                 'ì§„ë‹¨ëª… ë¯¸ì…ë ¥';
            document.getElementById('previewDiagnosis').textContent = diagnosisValue;
            
            // ì˜ì‚¬ ì†Œê²¬ ì„¤ì •
            const notesValue = formData.get('doctorNotes') || 'íŠ¹ì´ì‚¬í•­ ì—†ìŒ';
            document.getElementById('previewNotes').textContent = notesValue;
            
            // ì¬ì§„ ì˜ˆì •ì¼ ì„¤ì •
            document.getElementById('previewFollowUp').textContent = followUpText;
            
            // ì²˜ë°© ì•½ë¬¼ í…Œì´ë¸” ìƒì„±
            const medicationTableBody = document.getElementById('previewMedicationTableBody');
            const medications = collectMedicationData();
            
            if (medications.length === 0) {
                medicationTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; color: #666; font-style: italic;">
                            ì²˜ë°©ëœ ì•½ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
            } else {
                medicationTableBody.innerHTML = medications.map(med => `
                    <tr>
                        <td>${med.name || 'ì•½ë¬¼ëª… ë¯¸ì…ë ¥'}</td>
                        <td>${med.dosage || 'ìš©ëŸ‰ ë¯¸ì…ë ¥'} - ${med.frequency || 'ë³µìš©íšŸìˆ˜ ë¯¸ì…ë ¥'}</td>
                        <td>${med.days || '0'}ì¼ë¶„</td>
                        <td>${med.instructions || ''} ${med.coverage ? '(' + med.coverage + ')' : ''}</td>
                    </tr>
                `).join('');
            }
            
            document.getElementById('prescriptionPreview').classList.remove('hidden');
        }

        // ì§„ë£Œ ì™„ë£Œ ë²„íŠ¼ í•¸ë“¤ëŸ¬
        function handleCompleteReception() {
            console.log('ì§„ë£Œ ì™„ë£Œ ë²„íŠ¼ í•¸ë“¤ëŸ¬ í˜¸ì¶œë¨');
            completeReception();
        }

        // ì§„ë£Œ ì™„ë£Œ
        async function completeReception() {
            console.log('ì§„ë£Œ ì™„ë£Œ í•¨ìˆ˜ ì‹œì‘');
            console.log('prescriptionSaved:', prescriptionSaved);
            console.log('currentPatient:', currentPatient);
            console.log('currentReception:', currentReception);
            
            if (!currentReception) {
                console.error('currentReceptionì´ nullì…ë‹ˆë‹¤.');
                showAlert('ì„ íƒëœ í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            if (!prescriptionSaved) {
                console.warn('ì²˜ë°©ì „ì´ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                showAlert('ì²˜ë°©ì „ì„ ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            if (!confirm('ì§„ë£Œë¥¼ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                console.log('ì‚¬ìš©ìê°€ ì§„ë£Œ ì™„ë£Œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                const receptionId = currentReception.id;
                console.log('ì§„ë£Œ ì™„ë£Œ API í˜¸ì¶œ:', `/api/doctor/complete/${receptionId}`);
                
                const response = await fetch(`/api/doctor/complete/${receptionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('API ì‘ë‹µ ìƒíƒœ:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API ì˜¤ë¥˜ ì‘ë‹µ:', errorText);
                    let errorMessage = 'ì§„ë£Œ ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨';
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.message || errorMessage;
                    } catch (e) {
                        // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ í…ìŠ¤íŠ¸ ì‚¬ìš©
                        errorMessage = errorText;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                console.log('ì§„ë£Œ ì™„ë£Œ ì„±ê³µ:', result);
                
                showAlert('ì§„ë£Œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì²˜ë°©ì „ì´ ê°„í˜¸ì‚¬ì—ê²Œ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                
                // í¼ ì´ˆê¸°í™”
                resetForm();
                
                // ëŒ€ê¸°ì—´ ìƒˆë¡œê³ ì¹¨
                loadWaitingQueue();
                loadCurrentPatients();
            } catch (error) {
                console.error('ì§„ë£Œ ì™„ë£Œ ì‹¤íŒ¨:', error);
                showAlert('ì§„ë£Œ ì™„ë£Œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ' + error.message, 'error');
            }
        }

        // í¼ ì´ˆê¸°í™”
        function resetForm() {
            console.log('í¼ ì´ˆê¸°í™” ì‹œì‘');
            
            // í™˜ì ì •ë³´ ìˆ¨ê¸°ê¸°
            document.getElementById('patientInfo').classList.add('hidden');
            document.getElementById('prescriptionForm').classList.add('hidden');
            document.getElementById('prescriptionPreview').classList.add('hidden');
            document.getElementById('vitalSignInfo').classList.add('hidden');
            document.getElementById('surveyInfo').classList.add('hidden');
            
            // ë¹ˆ ìƒíƒœ í‘œì‹œ
            document.getElementById('emptyState').classList.remove('hidden');
            
            // í¼ ë°ì´í„° ì´ˆê¸°í™”
            document.getElementById('prescriptionFormData').reset();
            
            // ì•½ë¬¼ í…Œì´ë¸” ì´ˆê¸°í™”
            document.getElementById('medicationTableBody').innerHTML = '';
            
            // ì§„ë‹¨ëª… í…Œì´ë¸” ì´ˆê¸°í™”
            document.getElementById('diagnosisTableBody').innerHTML = '';
            
            // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
            currentPatient = null;
            currentReception = null;
            prescriptionSaved = false;
            
            // ì§„ë£Œ ì™„ë£Œ ë²„íŠ¼ ë¹„í™œì„±í™”
            const completeBtn = document.getElementById('completeBtn');
            if (completeBtn) {
                completeBtn.disabled = true;
                completeBtn.style.backgroundColor = '#6c757d';
                completeBtn.style.cursor = 'not-allowed';
                completeBtn.style.opacity = '0.6';
            }
            
            console.log('í¼ ì´ˆê¸°í™” ì™„ë£Œ');
        }

        // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
        function showAlert(message, type) {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.classList.remove('hidden');
            
            setTimeout(() => {
                alertDiv.classList.add('hidden');
            }, 5000);
        }

        // ========== ì•”í˜¸ í™•ì¸ í•¨ìˆ˜ ==========
        
        // ì•”í˜¸ í™•ì¸
        function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('passwordError');
            
            // ì˜ì‚¬ í˜ì´ì§€ ì•”í˜¸ (ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” ë” ì•ˆì „í•œ ë°©ë²• ì‚¬ìš©)
            const correctPassword = 'doctor123';
            
            if (password === correctPassword) {
                // ì•”í˜¸ ë§ìŒ - ë©”ì¸ ì»¨í…ì¸  í‘œì‹œ
                document.getElementById('passwordOverlay').style.display = 'none';
                document.querySelector('.main-content-wrapper').style.display = 'block';
                
                // ë°ì´í„° ë¡œë“œ ì‹œì‘
                loadWaitingQueue();
                loadCurrentPatients();
            } else {
                // ì•”í˜¸ í‹€ë¦¼
                errorDiv.textContent = 'ì•”í˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
                
                // ì—ëŸ¬ ë©”ì‹œì§€ 3ì´ˆ í›„ ìë™ ì‚­ì œ
                setTimeout(() => {
                    errorDiv.textContent = '';
                }, 3000);
            }
        }
        
        // ì—”í„°í‚¤ë¡œ ì•”í˜¸ í™•ì¸
        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // ì§„ë£Œ ì¤‘ì¸ í™˜ì ì‚­ì œ
        async function deleteCurrentPatient(receptionId, patientName) {
            const confirmation = confirm(`âš ï¸ ì§„ë£Œ ì¤‘ì¸ í™˜ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní™˜ìëª…: ${patientName}\nì ‘ìˆ˜ ID: ${receptionId}\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì§„ë£Œ ê¸°ë¡ê³¼ ì²˜ë°©ì „ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.`);
            
            if (!confirmation) {
                return;
            }
            
            try {
                const response = await fetch(`/api/nurse/reception/${receptionId}/force`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'í™˜ì ì‚­ì œ ì‹¤íŒ¨');
                }
                
                const result = await response.json();
                showAlert(`í™˜ì "${patientName}"ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                
                // í˜„ì¬ ì„ íƒëœ í™˜ìê°€ ì‚­ì œëœ í™˜ìì¸ ê²½ìš° í¼ ì´ˆê¸°í™”
                if (currentReception && currentReception.id === receptionId) {
                    resetForm();
                }
                
                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadWaitingQueue();
                loadCurrentPatients();
                
            } catch (error) {
                console.error('í™˜ì ì‚­ì œ ì‹¤íŒ¨:', error);
                showAlert('í™˜ì ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        }

    </script>
    </div> <!-- main-content-wrapper ë -->
</body>
</html> 